

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Fast cube root, square root, and reciprocal for x86/SSE CPUs. &mdash; Musicdsp.org  documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Fast exp() approximations" href="222-fast-exp-approximations.html" />
    <link rel="prev" title="Fast binary log approximations" href="91-fast-binary-log-approximations.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> Musicdsp.org
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../Synthesis/index.html">Synthesis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Analysis/index.html">Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Filters/index.html">Filters</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Effects/index.html">Effects</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Other</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="212-16-point-fast-integer-sinc-interpolator.html">16-Point Fast Integer Sinc Interpolator.</a></li>
<li class="toctree-l2"><a class="reference internal" href="95-16-to-8-bit-first-order-dither.html">16-to-8-bit first-order dither</a></li>
<li class="toctree-l2"><a class="reference internal" href="62-3rd-order-spline-interpollation.html">3rd order Spline interpollation</a></li>
<li class="toctree-l2"><a class="reference internal" href="60-5-point-spline-interpollation.html">5-point spline interpollation</a></li>
<li class="toctree-l2"><a class="reference internal" href="54-allocating-aligned-memory.html">Allocating aligned memory</a></li>
<li class="toctree-l2"><a class="reference internal" href="162-antialiased-lines.html">Antialiased Lines</a></li>
<li class="toctree-l2"><a class="reference internal" href="228-automatic-pdc-system.html">Automatic PDC system</a></li>
<li class="toctree-l2"><a class="reference internal" href="50-base-2-exp.html">Base-2 exp</a></li>
<li class="toctree-l2"><a class="reference internal" href="171-bit-reversed-counting.html">Bit-Reversed Counting</a></li>
<li class="toctree-l2"><a class="reference internal" href="149-block-loop-benchmarking.html">Block/Loop Benchmarking</a></li>
<li class="toctree-l2"><a class="reference internal" href="210-branchless-clipping.html">Branchless Clipping</a></li>
<li class="toctree-l2"><a class="reference internal" href="103-calculate-notes-java.html">Calculate notes (java)</a></li>
<li class="toctree-l2"><a class="reference internal" href="163-center-separation-in-a-stereo-mixdown.html">Center separation in a stereo mixdown</a></li>
<li class="toctree-l2"><a class="reference internal" href="165-center-separation-in-a-stereo-mixdown.html">Center separation in a stereo mixdown</a></li>
<li class="toctree-l2"><a class="reference internal" href="166-cheap-pseudo-sinusoidal-lfo.html">Cheap pseudo-sinusoidal lfo</a></li>
<li class="toctree-l2"><a class="reference internal" href="81-clipping-without-branching.html">Clipping without branching</a></li>
<li class="toctree-l2"><a class="reference internal" href="71-constant-time-exponent-of-2-detector.html">Constant-time exponent of 2 detector</a></li>
<li class="toctree-l2"><a class="reference internal" href="248-conversion-and-normalization-of-16-bit-sample-to-a-floating-point-number.html">Conversion and normalization of 16-bit sample to a floating point number</a></li>
<li class="toctree-l2"><a class="reference internal" href="52-conversions-on-a-powerpc.html">Conversions on a PowerPC</a></li>
<li class="toctree-l2"><a class="reference internal" href="49-cubic-interpollation.html">Cubic interpollation</a></li>
<li class="toctree-l2"><a class="reference internal" href="191-cure-for-malicious-samples.html">Cure for malicious samples</a></li>
<li class="toctree-l2"><a class="reference internal" href="88-denormal-double-variables-macro.html">Denormal DOUBLE variables, macro</a></li>
<li class="toctree-l2"><a class="reference internal" href="51-denormal-numbers.html">Denormal numbers</a></li>
<li class="toctree-l2"><a class="reference internal" href="83-denormal-numbers-the-meta-text.html">Denormal numbers, the meta-text</a></li>
<li class="toctree-l2"><a class="reference internal" href="193-denormalization-preventer.html">Denormalization preventer</a></li>
<li class="toctree-l2"><a class="reference internal" href="233-denormalization-preventer.html">Denormalization preventer</a></li>
<li class="toctree-l2"><a class="reference internal" href="61-dither-code.html">Dither code</a></li>
<li class="toctree-l2"><a class="reference internal" href="77-dithering.html">Dithering</a></li>
<li class="toctree-l2"><a class="reference internal" href="48-double-to-int.html">Double to Int</a></li>
<li class="toctree-l2"><a class="reference internal" href="138-envelope-follower.html">Envelope Follower</a></li>
<li class="toctree-l2"><a class="reference internal" href="260-exponential-curve-for.html">Exponential curve for</a></li>
<li class="toctree-l2"><a class="reference internal" href="87-exponential-parameter-mapping.html">Exponential parameter mapping</a></li>
<li class="toctree-l2"><a class="reference internal" href="273-fast-float-random-numbers.html">Fast Float Random Numbers</a></li>
<li class="toctree-l2"><a class="reference internal" href="132-fast-abs-neg-sign-for-32bit-floats.html">Fast abs/neg/sign for 32bit floats</a></li>
<li class="toctree-l2"><a class="reference internal" href="91-fast-binary-log-approximations.html">Fast binary log approximations</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Fast cube root, square root, and reciprocal for x86/SSE CPUs.</a></li>
<li class="toctree-l2"><a class="reference internal" href="222-fast-exp-approximations.html">Fast exp() approximations</a></li>
<li class="toctree-l2"><a class="reference internal" href="106-fast-exp2-approximation.html">Fast exp2 approximation</a></li>
<li class="toctree-l2"><a class="reference internal" href="63-fast-log2.html">Fast log2</a></li>
<li class="toctree-l2"><a class="reference internal" href="133-fast-power-and-root-estimates-for-32bit-floats.html">Fast power and root estimates for 32bit floats</a></li>
<li class="toctree-l2"><a class="reference internal" href="252-fast-rounding-functions-in-pascal.html">Fast rounding functions in pascal</a></li>
<li class="toctree-l2"><a class="reference internal" href="249-fast-sign-for-32-bit-floats.html">Fast sign for 32 bit floats</a></li>
<li class="toctree-l2"><a class="reference internal" href="56-float-to-int.html">Float to int</a></li>
<li class="toctree-l2"><a class="reference internal" href="170-float-to-int-more-intel-asm.html">Float to int (more intel asm)</a></li>
<li class="toctree-l2"><a class="reference internal" href="246-float-to-integer-conversion.html">Float to integer conversion</a></li>
<li class="toctree-l2"><a class="reference internal" href="57-float-to-int-coverting-an-array-of-floats.html">Float-to-int, coverting an array of floats</a></li>
<li class="toctree-l2"><a class="reference internal" href="121-gaussian-dithering.html">Gaussian dithering</a></li>
<li class="toctree-l2"><a class="reference internal" href="129-gaussian-random-numbers.html">Gaussian random numbers</a></li>
<li class="toctree-l2"><a class="reference internal" href="157-hermite-interpolator-x86-asm.html">Hermite Interpolator (x86 ASM)</a></li>
<li class="toctree-l2"><a class="reference internal" href="93-hermite-interpollation.html">Hermite interpollation</a></li>
<li class="toctree-l2"><a class="reference internal" href="245-linear-interpolation.html">Linear interpolation</a></li>
<li class="toctree-l2"><a class="reference internal" href="119-lock-free-fifo.html">Lock free fifo</a></li>
<li class="toctree-l2"><a class="reference internal" href="58-matlab-tools-for-sndan.html">MATLAB-Tools for SNDAN</a></li>
<li class="toctree-l2"><a class="reference internal" href="125-midi-note-frequency-conversion.html">MIDI note/frequency conversion</a></li>
<li class="toctree-l2"><a class="reference internal" href="188-matlab-time-domain-impulse-response-inverter-divider.html">Matlab Time Domain Impulse Response Inverter/Divider</a></li>
<li class="toctree-l2"><a class="reference internal" href="94-millimeter-to-db-faders.html">Millimeter to DB (faders…)</a></li>
<li class="toctree-l2"><a class="reference internal" href="202-motorola-56300-disassembler.html">Motorola 56300 Disassembler</a></li>
<li class="toctree-l2"><a class="reference internal" href="99-noise-shaping-class.html">Noise Shaping Class</a></li>
<li class="toctree-l2"><a class="reference internal" href="148-nonblocking-multiprocessor-multithread-algorithms-in-c.html">Nonblocking multiprocessor/multithread algorithms in C++</a></li>
<li class="toctree-l2"><a class="reference internal" href="250-piecewise-quadratic-approximate-exponential-function.html">Piecewise quadratic approximate exponential function</a></li>
<li class="toctree-l2"><a class="reference internal" href="55-pow-x-4-approximation.html">Pow(x,4) approximation</a></li>
<li class="toctree-l2"><a class="reference internal" href="238-rational-tanh-approximation.html">Rational tanh approximation</a></li>
<li class="toctree-l2"><a class="reference internal" href="84-reading-the-compressed-wa-parts-in-gigasampler-files.html">Reading the compressed WA! parts in gigasampler files</a></li>
<li class="toctree-l2"><a class="reference internal" href="158-really-fast-x86-floating-point-sin-cos.html">Really fast x86 floating point sin/cos</a></li>
<li class="toctree-l2"><a class="reference internal" href="178-reasonably-accurate-fastish-tanh-approximation.html">Reasonably accurate/fastish tanh approximation</a></li>
<li class="toctree-l2"><a class="reference internal" href="164-resampling.html">Resampling</a></li>
<li class="toctree-l2"><a class="reference internal" href="120-saturation.html">Saturation</a></li>
<li class="toctree-l2"><a class="reference internal" href="175-sin-x-aproximation-with-sse-code.html">Sin(x) Aproximation (with SSE code)</a></li>
<li class="toctree-l2"><a class="reference internal" href="115-sin-cos-tan-approximation.html">Sin, Cos, Tan approximation</a></li>
<li class="toctree-l2"><a class="reference internal" href="182-vst-sdk-gui-switch-without.html">VST SDK GUI Switch without</a></li>
</ul>
</li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Musicdsp.org</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Other</a> &raquo;</li>
        
      <li>Fast cube root, square root, and reciprocal for x86/SSE CPUs.</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/Other/206-fast-cube-root-square-root-and-reciprocal-for-x86-sse-cpus.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="fast-cube-root-square-root-and-reciprocal-for-x86-sse-cpus">
<h1>Fast cube root, square root, and reciprocal for x86/SSE CPUs.<a class="headerlink" href="#fast-cube-root-square-root-and-reciprocal-for-x86-sse-cpus" title="Permalink to this headline">¶</a></h1>
<ul class="simple">
<li><p><strong>Author or source:</strong> <a class="reference external" href="mailto:moc&#46;noicratse&#37;&#52;&#48;ajelak">moc<span>&#46;</span>noicratse<span>&#64;</span>ajelak</a></p></li>
<li><p><strong>Created:</strong> 2005-05-29 18:36:40</p></li>
</ul>
<div class="literal-block-wrapper docutils container" id="id1">
<div class="code-block-caption"><span class="caption-text">notes</span><a class="headerlink" href="#id1" title="Permalink to this code">¶</a></div>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>All of these methods use SSE instructions or bit twiddling tricks to get a rough
approximation to cube root, square root, or reciprocal, which is then refined with one or
more Newton-Raphson approximation steps.

Each is named to indicate its approximate level of accuracy and a comment describes its
performance relative to the conventional versions.
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id2">
<div class="code-block-caption"><span class="caption-text">code</span><a class="headerlink" href="#id2" title="Permalink to this code">¶</a></div>
<div class="highlight-c++ notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">// These functions approximate reciprocal, square root, and</span>
<span class="c1">// cube root to varying degrees of precision substantially</span>
<span class="c1">// faster than the straightforward methods 1/x, sqrtf(x),</span>
<span class="c1">// and powf( x, 1.0f/3.0f ). All require SSE-enabled CPU &amp; OS.</span>
<span class="c1">// Unlike the powf() solution, the cube roots also correctly</span>
<span class="c1">// handle negative inputs.</span>

<span class="cp">#define REALLY_INLINE __forceinline</span>

<span class="c1">// ~34 clocks on Pentium M vs. ~360 for powf</span>
<span class="n">REALLY_INLINE</span> <span class="kt">float</span> <span class="nf">cuberoot_sse_8bits</span><span class="p">(</span> <span class="kt">float</span> <span class="n">x</span> <span class="p">)</span>
<span class="p">{</span>
    <span class="kt">float</span> <span class="n">z</span><span class="p">;</span>
    <span class="k">static</span> <span class="k">const</span> <span class="kt">float</span> <span class="n">three</span> <span class="o">=</span> <span class="mf">3.0f</span><span class="p">;</span>
    <span class="n">_asm</span>
    <span class="p">{</span>
            <span class="n">mov</span>             <span class="n">eax</span><span class="p">,</span> <span class="n">x</span>                          <span class="c1">// x as bits</span>
            <span class="n">movss</span>   <span class="n">xmm2</span><span class="p">,</span> <span class="n">x</span>                         <span class="c1">// x2: x</span>
            <span class="n">movss</span>   <span class="n">xmm1</span><span class="p">,</span> <span class="n">three</span>                     <span class="c1">// x1: 3</span>
            <span class="c1">// Magic floating point cube root done with integer math.</span>
            <span class="c1">// The exponent is divided by three in such a way that</span>
            <span class="c1">// remainder bits get shoved into the top of the normalized</span>
            <span class="c1">// mantissa.</span>
            <span class="n">mov</span>             <span class="n">ecx</span><span class="p">,</span> <span class="n">eax</span>                        <span class="c1">// copy of x</span>
            <span class="n">and</span>             <span class="n">eax</span><span class="p">,</span> <span class="mh">0x7FFFFFFF</span>         <span class="c1">// exponent &amp; mantissa of x in biased-127</span>
            <span class="n">sub</span>     <span class="n">eax</span><span class="p">,</span> <span class="mh">0x3F800000</span>         <span class="c1">// exponent &amp; mantissa of x in 2&#39;s comp</span>
            <span class="n">sar</span>     <span class="n">eax</span><span class="p">,</span> <span class="mi">10</span>                         <span class="c1">//</span>
            <span class="n">imul</span>    <span class="n">eax</span><span class="p">,</span> <span class="mi">341</span>                        <span class="c1">// 341/1024 ~= .333</span>
            <span class="n">add</span>             <span class="n">eax</span><span class="p">,</span> <span class="mh">0x3F800000</span>         <span class="c1">// back to biased-127</span>
            <span class="n">and</span>     <span class="n">eax</span><span class="p">,</span> <span class="mh">0x7FFFFFFF</span>         <span class="c1">// remask</span>
            <span class="n">and</span>             <span class="n">ecx</span><span class="p">,</span> <span class="mh">0x80000000</span>         <span class="c1">// original sign and mantissa</span>
            <span class="n">or</span>      <span class="n">eax</span><span class="p">,</span> <span class="n">ecx</span>                        <span class="c1">// masked new exponent, old sign and mantissa</span>
            <span class="n">mov</span>             <span class="n">z</span><span class="p">,</span> <span class="n">eax</span>                          <span class="c1">//</span>

            <span class="c1">// use SSE to refine the first approximation</span>
            <span class="n">movss</span>   <span class="n">xmm0</span><span class="p">,</span> <span class="n">z</span>                         <span class="p">;</span><span class="c1">// x0: z</span>
            <span class="n">movss</span>   <span class="n">xmm3</span><span class="p">,</span> <span class="n">xmm0</span>                      <span class="p">;</span><span class="c1">// x3: z</span>
            <span class="n">mulss</span>   <span class="n">xmm3</span><span class="p">,</span> <span class="n">xmm0</span>                      <span class="p">;</span><span class="c1">// x3: z*z</span>
            <span class="n">movss</span>   <span class="n">xmm4</span><span class="p">,</span> <span class="n">xmm3</span>                      <span class="p">;</span><span class="c1">// x4: z*z</span>
            <span class="n">mulss</span>   <span class="n">xmm3</span><span class="p">,</span> <span class="n">xmm1</span>                      <span class="p">;</span><span class="c1">// x3: 3*z*z</span>
            <span class="n">rcpss</span>   <span class="n">xmm3</span><span class="p">,</span> <span class="n">xmm3</span>                      <span class="p">;</span><span class="c1">// x3: ~ 1/(3*z*z)</span>
            <span class="n">mulss</span>   <span class="n">xmm4</span><span class="p">,</span> <span class="n">xmm0</span>                      <span class="p">;</span><span class="c1">// x4: z*z*z</span>
            <span class="n">subss</span>   <span class="n">xmm4</span><span class="p">,</span> <span class="n">xmm2</span>                      <span class="p">;</span><span class="c1">// x4: z*z*z-x</span>
            <span class="n">mulss</span>   <span class="n">xmm4</span><span class="p">,</span> <span class="n">xmm3</span>                      <span class="p">;</span><span class="c1">// x4: (z*z*z-x) / (3*z*z)</span>
            <span class="n">subss</span>   <span class="n">xmm0</span><span class="p">,</span> <span class="n">xmm4</span>                      <span class="p">;</span><span class="c1">// x0: z&#39; accurate to within about 0.3%</span>
            <span class="n">movss</span>   <span class="n">z</span><span class="p">,</span> <span class="n">xmm0</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">z</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// ~60 clocks on Pentium M vs. ~360 for powf</span>
<span class="n">REALLY_INLINE</span> <span class="kt">float</span> <span class="nf">cuberoot_sse_16bits</span><span class="p">(</span> <span class="kt">float</span> <span class="n">x</span> <span class="p">)</span>
<span class="p">{</span>
    <span class="kt">float</span> <span class="n">z</span><span class="p">;</span>
    <span class="k">static</span> <span class="k">const</span> <span class="kt">float</span> <span class="n">three</span> <span class="o">=</span> <span class="mf">3.0f</span><span class="p">;</span>
    <span class="n">_asm</span>
    <span class="p">{</span>
            <span class="n">mov</span>             <span class="n">eax</span><span class="p">,</span> <span class="n">x</span>                          <span class="c1">// x as bits</span>
            <span class="n">movss</span>   <span class="n">xmm2</span><span class="p">,</span> <span class="n">x</span>                         <span class="c1">// x2: x</span>
            <span class="n">movss</span>   <span class="n">xmm1</span><span class="p">,</span> <span class="n">three</span>                     <span class="c1">// x1: 3</span>
            <span class="c1">// Magic floating point cube root done with integer math.</span>
            <span class="c1">// The exponent is divided by three in such a way that</span>
            <span class="c1">// remainder bits get shoved into the top of the normalized</span>
            <span class="c1">// mantissa.</span>
            <span class="n">mov</span>             <span class="n">ecx</span><span class="p">,</span> <span class="n">eax</span>                        <span class="c1">// copy of x</span>
            <span class="n">and</span>             <span class="n">eax</span><span class="p">,</span> <span class="mh">0x7FFFFFFF</span>         <span class="c1">// exponent &amp; mantissa of x in biased-127</span>
            <span class="n">sub</span>     <span class="n">eax</span><span class="p">,</span> <span class="mh">0x3F800000</span>         <span class="c1">// exponent &amp; mantissa of x in 2&#39;s comp</span>
            <span class="n">sar</span>     <span class="n">eax</span><span class="p">,</span> <span class="mi">10</span>                         <span class="c1">//</span>
            <span class="n">imul</span>    <span class="n">eax</span><span class="p">,</span> <span class="mi">341</span>                        <span class="c1">// 341/1024 ~= .333</span>
            <span class="n">add</span>             <span class="n">eax</span><span class="p">,</span> <span class="mh">0x3F800000</span>         <span class="c1">// back to biased-127</span>
            <span class="n">and</span>     <span class="n">eax</span><span class="p">,</span> <span class="mh">0x7FFFFFFF</span>         <span class="c1">// remask</span>
            <span class="n">and</span>             <span class="n">ecx</span><span class="p">,</span> <span class="mh">0x80000000</span>         <span class="c1">// original sign and mantissa</span>
            <span class="n">or</span>      <span class="n">eax</span><span class="p">,</span> <span class="n">ecx</span>                        <span class="c1">// masked new exponent, old sign and mantissa</span>
            <span class="n">mov</span>             <span class="n">z</span><span class="p">,</span> <span class="n">eax</span>                          <span class="c1">//</span>

            <span class="c1">// use SSE to refine the first approximation</span>
            <span class="n">movss</span>   <span class="n">xmm0</span><span class="p">,</span> <span class="n">z</span>                         <span class="p">;</span><span class="c1">// x0: z</span>
            <span class="n">movss</span>   <span class="n">xmm3</span><span class="p">,</span> <span class="n">xmm0</span>                      <span class="p">;</span><span class="c1">// x3: z</span>
            <span class="n">mulss</span>   <span class="n">xmm3</span><span class="p">,</span> <span class="n">xmm0</span>                      <span class="p">;</span><span class="c1">// x3: z*z</span>
            <span class="n">movss</span>   <span class="n">xmm4</span><span class="p">,</span> <span class="n">xmm3</span>                      <span class="p">;</span><span class="c1">// x4: z*z</span>
            <span class="n">mulss</span>   <span class="n">xmm3</span><span class="p">,</span> <span class="n">xmm1</span>                      <span class="p">;</span><span class="c1">// x3: 3*z*z</span>
            <span class="n">rcpss</span>   <span class="n">xmm3</span><span class="p">,</span> <span class="n">xmm3</span>                      <span class="p">;</span><span class="c1">// x3: ~ 1/(3*z*z)</span>
            <span class="n">mulss</span>   <span class="n">xmm4</span><span class="p">,</span> <span class="n">xmm0</span>                      <span class="p">;</span><span class="c1">// x4: z*z*z</span>
            <span class="n">subss</span>   <span class="n">xmm4</span><span class="p">,</span> <span class="n">xmm2</span>                      <span class="p">;</span><span class="c1">// x4: z*z*z-x</span>
            <span class="n">mulss</span>   <span class="n">xmm4</span><span class="p">,</span> <span class="n">xmm3</span>                      <span class="p">;</span><span class="c1">// x4: (z*z*z-x) / (3*z*z)</span>
            <span class="n">subss</span>   <span class="n">xmm0</span><span class="p">,</span> <span class="n">xmm4</span>                      <span class="p">;</span><span class="c1">// x0: z&#39; accurate to within about 0.3%</span>

            <span class="n">movss</span>   <span class="n">xmm3</span><span class="p">,</span> <span class="n">xmm0</span>                      <span class="p">;</span><span class="c1">// x3: z</span>
            <span class="n">mulss</span>   <span class="n">xmm3</span><span class="p">,</span> <span class="n">xmm0</span>                      <span class="p">;</span><span class="c1">// x3: z*z</span>
            <span class="n">movss</span>   <span class="n">xmm4</span><span class="p">,</span> <span class="n">xmm3</span>                      <span class="p">;</span><span class="c1">// x4: z*z</span>
            <span class="n">mulss</span>   <span class="n">xmm3</span><span class="p">,</span> <span class="n">xmm1</span>                      <span class="p">;</span><span class="c1">// x3: 3*z*z</span>
            <span class="n">rcpss</span>   <span class="n">xmm3</span><span class="p">,</span> <span class="n">xmm3</span>                      <span class="p">;</span><span class="c1">// x3: ~ 1/(3*z*z)</span>
            <span class="n">mulss</span>   <span class="n">xmm4</span><span class="p">,</span> <span class="n">xmm0</span>                      <span class="p">;</span><span class="c1">// x4: z*z*z</span>
            <span class="n">subss</span>   <span class="n">xmm4</span><span class="p">,</span> <span class="n">xmm2</span>                      <span class="p">;</span><span class="c1">// x4: z*z*z-x</span>
            <span class="n">mulss</span>   <span class="n">xmm4</span><span class="p">,</span> <span class="n">xmm3</span>                      <span class="p">;</span><span class="c1">// x4: (z*z*z-x) / (3*z*z)</span>
            <span class="n">subss</span>   <span class="n">xmm0</span><span class="p">,</span> <span class="n">xmm4</span>                      <span class="p">;</span><span class="c1">// x0: z&#39;&#39; accurate to within about 0.001%</span>

            <span class="n">movss</span>   <span class="n">z</span><span class="p">,</span> <span class="n">xmm0</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">z</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// ~77 clocks on Pentium M vs. ~360 for powf</span>
<span class="n">REALLY_INLINE</span> <span class="kt">float</span> <span class="nf">cuberoot_sse_22bits</span><span class="p">(</span> <span class="kt">float</span> <span class="n">x</span> <span class="p">)</span>
<span class="p">{</span>
    <span class="kt">float</span> <span class="n">z</span><span class="p">;</span>
    <span class="k">static</span> <span class="k">const</span> <span class="kt">float</span> <span class="n">three</span> <span class="o">=</span> <span class="mf">3.0f</span><span class="p">;</span>
    <span class="n">_asm</span>
    <span class="p">{</span>
            <span class="n">mov</span>             <span class="n">eax</span><span class="p">,</span> <span class="n">x</span>                          <span class="c1">// x as bits</span>
            <span class="n">movss</span>   <span class="n">xmm2</span><span class="p">,</span> <span class="n">x</span>                         <span class="c1">// x2: x</span>
            <span class="n">movss</span>   <span class="n">xmm1</span><span class="p">,</span> <span class="n">three</span>                     <span class="c1">// x1: 3</span>
            <span class="c1">// Magic floating point cube root done with integer math.</span>
            <span class="c1">// The exponent is divided by three in such a way that</span>
            <span class="c1">// remainder bits get shoved into the top of the normalized</span>
            <span class="c1">// mantissa.</span>
            <span class="n">mov</span>             <span class="n">ecx</span><span class="p">,</span> <span class="n">eax</span>                        <span class="c1">// copy of x</span>
            <span class="n">and</span>             <span class="n">eax</span><span class="p">,</span> <span class="mh">0x7FFFFFFF</span>         <span class="c1">// exponent &amp; mantissa of x in biased-127</span>
            <span class="n">sub</span>     <span class="n">eax</span><span class="p">,</span> <span class="mh">0x3F800000</span>         <span class="c1">// exponent &amp; mantissa of x in 2&#39;s comp</span>
            <span class="n">sar</span>     <span class="n">eax</span><span class="p">,</span> <span class="mi">10</span>                         <span class="c1">//</span>
            <span class="n">imul</span>    <span class="n">eax</span><span class="p">,</span> <span class="mi">341</span>                        <span class="c1">// 341/1024 ~= .333</span>
            <span class="n">add</span>             <span class="n">eax</span><span class="p">,</span> <span class="mh">0x3F800000</span>         <span class="c1">// back to biased-127</span>
            <span class="n">and</span>     <span class="n">eax</span><span class="p">,</span> <span class="mh">0x7FFFFFFF</span>         <span class="c1">// remask</span>
            <span class="n">and</span>             <span class="n">ecx</span><span class="p">,</span> <span class="mh">0x80000000</span>         <span class="c1">// original sign and mantissa</span>
            <span class="n">or</span>      <span class="n">eax</span><span class="p">,</span> <span class="n">ecx</span>                        <span class="c1">// masked new exponent, old sign and mantissa</span>
            <span class="n">mov</span>             <span class="n">z</span><span class="p">,</span> <span class="n">eax</span>                          <span class="c1">//</span>

            <span class="c1">// use SSE to refine the first approximation</span>
            <span class="n">movss</span>   <span class="n">xmm0</span><span class="p">,</span> <span class="n">z</span>                         <span class="c1">// x0: z</span>
            <span class="n">movss</span>   <span class="n">xmm3</span><span class="p">,</span> <span class="n">xmm0</span>                      <span class="c1">// x3: z</span>
            <span class="n">mulss</span>   <span class="n">xmm3</span><span class="p">,</span> <span class="n">xmm0</span>                      <span class="c1">// x3: z*z</span>
            <span class="n">movss</span>   <span class="n">xmm4</span><span class="p">,</span> <span class="n">xmm3</span>                      <span class="c1">// x4: z*z</span>
            <span class="n">mulss</span>   <span class="n">xmm3</span><span class="p">,</span> <span class="n">xmm1</span>                      <span class="c1">// x3: 3*z*z</span>
            <span class="n">rcpss</span>   <span class="n">xmm3</span><span class="p">,</span> <span class="n">xmm3</span>                      <span class="c1">// x3: ~ 1/(3*z*z)</span>
            <span class="n">mulss</span>   <span class="n">xmm4</span><span class="p">,</span> <span class="n">xmm0</span>                      <span class="c1">// x4: z*z*z</span>
            <span class="n">subss</span>   <span class="n">xmm4</span><span class="p">,</span> <span class="n">xmm2</span>                      <span class="c1">// x4: z*z*z-x</span>
            <span class="n">mulss</span>   <span class="n">xmm4</span><span class="p">,</span> <span class="n">xmm3</span>                      <span class="c1">// x4: (z*z*z-x) / (3*z*z)</span>
            <span class="n">subss</span>   <span class="n">xmm0</span><span class="p">,</span> <span class="n">xmm4</span>                      <span class="c1">// x0: z&#39; accurate to within about 0.3%</span>

            <span class="n">movss</span>   <span class="n">xmm3</span><span class="p">,</span> <span class="n">xmm0</span>                      <span class="c1">// x3: z</span>
            <span class="n">mulss</span>   <span class="n">xmm3</span><span class="p">,</span> <span class="n">xmm0</span>                      <span class="c1">// x3: z*z</span>
            <span class="n">movss</span>   <span class="n">xmm4</span><span class="p">,</span> <span class="n">xmm3</span>                      <span class="c1">// x4: z*z</span>
            <span class="n">mulss</span>   <span class="n">xmm3</span><span class="p">,</span> <span class="n">xmm1</span>                      <span class="c1">// x3: 3*z*z</span>
            <span class="n">rcpss</span>   <span class="n">xmm3</span><span class="p">,</span> <span class="n">xmm3</span>                      <span class="c1">// x3: ~ 1/(3*z*z)</span>
            <span class="n">mulss</span>   <span class="n">xmm4</span><span class="p">,</span> <span class="n">xmm0</span>                      <span class="c1">// x4: z*z*z</span>
            <span class="n">subss</span>   <span class="n">xmm4</span><span class="p">,</span> <span class="n">xmm2</span>                      <span class="c1">// x4: z*z*z-x</span>
            <span class="n">mulss</span>   <span class="n">xmm4</span><span class="p">,</span> <span class="n">xmm3</span>                      <span class="c1">// x4: (z*z*z-x) / (3*z*z)</span>
            <span class="n">subss</span>   <span class="n">xmm0</span><span class="p">,</span> <span class="n">xmm4</span>                      <span class="c1">// x0: z&#39;&#39; accurate to within about 0.001%</span>

            <span class="n">movss</span>   <span class="n">xmm3</span><span class="p">,</span> <span class="n">xmm0</span>                      <span class="c1">// x3: z</span>
            <span class="n">mulss</span>   <span class="n">xmm3</span><span class="p">,</span> <span class="n">xmm0</span>                      <span class="c1">// x3: z*z</span>
            <span class="n">movss</span>   <span class="n">xmm4</span><span class="p">,</span> <span class="n">xmm3</span>                      <span class="c1">// x4: z*z</span>
            <span class="n">mulss</span>   <span class="n">xmm3</span><span class="p">,</span> <span class="n">xmm1</span>                      <span class="c1">// x3: 3*z*z</span>
            <span class="n">rcpss</span>   <span class="n">xmm3</span><span class="p">,</span> <span class="n">xmm3</span>                      <span class="c1">// x3: ~ 1/(3*z*z)</span>
            <span class="n">mulss</span>   <span class="n">xmm4</span><span class="p">,</span> <span class="n">xmm0</span>                      <span class="c1">// x4: z*z*z</span>
            <span class="n">subss</span>   <span class="n">xmm4</span><span class="p">,</span> <span class="n">xmm2</span>                      <span class="c1">// x4: z*z*z-x</span>
            <span class="n">mulss</span>   <span class="n">xmm4</span><span class="p">,</span> <span class="n">xmm3</span>                      <span class="c1">// x4: (z*z*z-x) / (3*z*z)</span>
            <span class="n">subss</span>   <span class="n">xmm0</span><span class="p">,</span> <span class="n">xmm4</span>                      <span class="c1">// x0: z&#39;&#39;&#39; accurate to within about 0.000012%</span>

            <span class="n">movss</span>   <span class="n">z</span><span class="p">,</span> <span class="n">xmm0</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">z</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// ~6 clocks on Pentium M vs. ~24 for single precision sqrtf</span>
<span class="n">REALLY_INLINE</span> <span class="kt">float</span> <span class="nf">squareroot_sse_11bits</span><span class="p">(</span> <span class="kt">float</span> <span class="n">x</span> <span class="p">)</span>
<span class="p">{</span>
    <span class="kt">float</span> <span class="n">z</span><span class="p">;</span>
    <span class="n">_asm</span>
    <span class="p">{</span>
            <span class="n">rsqrtss</span> <span class="n">xmm0</span><span class="p">,</span> <span class="n">x</span>
            <span class="n">rcpss</span>   <span class="n">xmm0</span><span class="p">,</span> <span class="n">xmm0</span>
            <span class="n">movss</span>   <span class="n">z</span><span class="p">,</span> <span class="n">xmm0</span>                 <span class="c1">// z ~= sqrt(x) to 0.038%</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">z</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// ~19 clocks on Pentium M vs. ~24 for single precision sqrtf</span>
<span class="n">REALLY_INLINE</span> <span class="kt">float</span> <span class="nf">squareroot_sse_22bits</span><span class="p">(</span> <span class="kt">float</span> <span class="n">x</span> <span class="p">)</span>
<span class="p">{</span>
    <span class="k">static</span> <span class="kt">float</span> <span class="n">half</span> <span class="o">=</span> <span class="mf">0.5f</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">z</span><span class="p">;</span>
    <span class="n">_asm</span>
    <span class="p">{</span>
            <span class="n">movss</span>   <span class="n">xmm1</span><span class="p">,</span> <span class="n">x</span>                 <span class="c1">// x1: x</span>
            <span class="n">rsqrtss</span> <span class="n">xmm2</span><span class="p">,</span> <span class="n">xmm1</span>              <span class="c1">// x2: ~1/sqrt(x) = 1/z</span>
            <span class="n">rcpss</span>   <span class="n">xmm0</span><span class="p">,</span> <span class="n">xmm2</span>              <span class="c1">// x0: z == ~sqrt(x) to 0.05%</span>

            <span class="n">movss</span>   <span class="n">xmm4</span><span class="p">,</span> <span class="n">xmm0</span>              <span class="c1">// x4: z</span>
            <span class="n">movss</span>   <span class="n">xmm3</span><span class="p">,</span> <span class="n">half</span>
            <span class="n">mulss</span>   <span class="n">xmm4</span><span class="p">,</span> <span class="n">xmm4</span>              <span class="c1">// x4: z*z</span>
            <span class="n">mulss</span>   <span class="n">xmm2</span><span class="p">,</span> <span class="n">xmm3</span>              <span class="c1">// x2: 1 / 2z</span>
            <span class="n">subss</span>   <span class="n">xmm4</span><span class="p">,</span> <span class="n">xmm1</span>              <span class="c1">// x4: z*z-x</span>
            <span class="n">mulss</span>   <span class="n">xmm4</span><span class="p">,</span> <span class="n">xmm2</span>              <span class="c1">// x4: (z*z-x)/2z</span>
            <span class="n">subss</span>   <span class="n">xmm0</span><span class="p">,</span> <span class="n">xmm4</span>              <span class="c1">// x0: z&#39; to 0.000015%</span>

            <span class="n">movss</span>   <span class="n">z</span><span class="p">,</span> <span class="n">xmm0</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">z</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// ~12 clocks on Pentium M vs. ~16 for single precision divide</span>
<span class="n">REALLY_INLINE</span> <span class="kt">float</span> <span class="nf">reciprocal_sse_22bits</span><span class="p">(</span> <span class="kt">float</span> <span class="n">x</span> <span class="p">)</span>
<span class="p">{</span>
    <span class="kt">float</span> <span class="n">z</span><span class="p">;</span>
    <span class="n">_asm</span>
    <span class="p">{</span>
            <span class="n">rcpss</span>   <span class="n">xmm0</span><span class="p">,</span> <span class="n">x</span>                 <span class="c1">// x0: z ~= 1/x</span>
            <span class="n">movss</span>   <span class="n">xmm2</span><span class="p">,</span> <span class="n">x</span>                 <span class="c1">// x2: x</span>
            <span class="n">movss</span>   <span class="n">xmm1</span><span class="p">,</span> <span class="n">xmm0</span>              <span class="c1">// x1: z ~= 1/x</span>
            <span class="n">addss</span>   <span class="n">xmm0</span><span class="p">,</span> <span class="n">xmm0</span>              <span class="c1">// x0: 2z</span>
            <span class="n">mulss</span>   <span class="n">xmm1</span><span class="p">,</span> <span class="n">xmm1</span>              <span class="c1">// x1: z^2</span>
            <span class="n">mulss</span>   <span class="n">xmm1</span><span class="p">,</span> <span class="n">xmm2</span>              <span class="c1">// x1: xz^2</span>
            <span class="n">subss</span>   <span class="n">xmm0</span><span class="p">,</span> <span class="n">xmm1</span>              <span class="c1">// x0: z&#39; ~= 1/x to 0.000012%</span>

            <span class="n">movss</span>   <span class="n">z</span><span class="p">,</span> <span class="n">xmm0</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">z</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="222-fast-exp-approximations.html" class="btn btn-neutral float-right" title="Fast exp() approximations" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="91-fast-binary-log-approximations.html" class="btn btn-neutral float-left" title="Fast binary log approximations" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Too many to list

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>