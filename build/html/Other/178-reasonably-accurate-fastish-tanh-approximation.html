

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Reasonably accurate/fastish tanh approximation &mdash; Notebook  documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Resampling" href="164-resampling.html" />
    <link rel="prev" title="Really fast x86 floating point sin/cos" href="158-really-fast-x86-floating-point-sin-cos.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> Notebook
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../Synthesis/index.html">Synthesis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Analysis/index.html">Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Filters/index.html">Filters</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Effects/index.html">Effects</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Other</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="212-16-point-fast-integer-sinc-interpolator.html">16-Point Fast Integer Sinc Interpolator.</a></li>
<li class="toctree-l2"><a class="reference internal" href="95-16-to-8-bit-first-order-dither.html">16-to-8-bit first-order dither</a></li>
<li class="toctree-l2"><a class="reference internal" href="62-3rd-order-spline-interpollation.html">3rd order Spline interpollation</a></li>
<li class="toctree-l2"><a class="reference internal" href="60-5-point-spline-interpollation.html">5-point spline interpollation</a></li>
<li class="toctree-l2"><a class="reference internal" href="54-allocating-aligned-memory.html">Allocating aligned memory</a></li>
<li class="toctree-l2"><a class="reference internal" href="162-antialiased-lines.html">Antialiased Lines</a></li>
<li class="toctree-l2"><a class="reference internal" href="228-automatic-pdc-system.html">Automatic PDC system</a></li>
<li class="toctree-l2"><a class="reference internal" href="50-base-2-exp.html">Base-2 exp</a></li>
<li class="toctree-l2"><a class="reference internal" href="171-bit-reversed-counting.html">Bit-Reversed Counting</a></li>
<li class="toctree-l2"><a class="reference internal" href="149-block-loop-benchmarking.html">Block/Loop Benchmarking</a></li>
<li class="toctree-l2"><a class="reference internal" href="210-branchless-clipping.html">Branchless Clipping</a></li>
<li class="toctree-l2"><a class="reference internal" href="103-calculate-notes-java.html">Calculate notes (java)</a></li>
<li class="toctree-l2"><a class="reference internal" href="163-center-separation-in-a-stereo-mixdown.html">Center separation in a stereo mixdown</a></li>
<li class="toctree-l2"><a class="reference internal" href="165-center-separation-in-a-stereo-mixdown.html">Center separation in a stereo mixdown</a></li>
<li class="toctree-l2"><a class="reference internal" href="166-cheap-pseudo-sinusoidal-lfo.html">Cheap pseudo-sinusoidal lfo</a></li>
<li class="toctree-l2"><a class="reference internal" href="81-clipping-without-branching.html">Clipping without branching</a></li>
<li class="toctree-l2"><a class="reference internal" href="71-constant-time-exponent-of-2-detector.html">Constant-time exponent of 2 detector</a></li>
<li class="toctree-l2"><a class="reference internal" href="248-conversion-and-normalization-of-16-bit-sample-to-a-floating-point-number.html">Conversion and normalization of 16-bit sample to a floating point number</a></li>
<li class="toctree-l2"><a class="reference internal" href="52-conversions-on-a-powerpc.html">Conversions on a PowerPC</a></li>
<li class="toctree-l2"><a class="reference internal" href="49-cubic-interpollation.html">Cubic interpollation</a></li>
<li class="toctree-l2"><a class="reference internal" href="191-cure-for-malicious-samples.html">Cure for malicious samples</a></li>
<li class="toctree-l2"><a class="reference internal" href="88-denormal-double-variables-macro.html">Denormal DOUBLE variables, macro</a></li>
<li class="toctree-l2"><a class="reference internal" href="51-denormal-numbers.html">Denormal numbers</a></li>
<li class="toctree-l2"><a class="reference internal" href="83-denormal-numbers-the-meta-text.html">Denormal numbers, the meta-text</a></li>
<li class="toctree-l2"><a class="reference internal" href="193-denormalization-preventer.html">Denormalization preventer</a></li>
<li class="toctree-l2"><a class="reference internal" href="233-denormalization-preventer.html">Denormalization preventer</a></li>
<li class="toctree-l2"><a class="reference internal" href="61-dither-code.html">Dither code</a></li>
<li class="toctree-l2"><a class="reference internal" href="77-dithering.html">Dithering</a></li>
<li class="toctree-l2"><a class="reference internal" href="48-double-to-int.html">Double to Int</a></li>
<li class="toctree-l2"><a class="reference internal" href="138-envelope-follower.html">Envelope Follower</a></li>
<li class="toctree-l2"><a class="reference internal" href="260-exponential-curve-for.html">Exponential curve for</a></li>
<li class="toctree-l2"><a class="reference internal" href="87-exponential-parameter-mapping.html">Exponential parameter mapping</a></li>
<li class="toctree-l2"><a class="reference internal" href="273-fast-float-random-numbers.html">Fast Float Random Numbers</a></li>
<li class="toctree-l2"><a class="reference internal" href="132-fast-abs-neg-sign-for-32bit-floats.html">Fast abs/neg/sign for 32bit floats</a></li>
<li class="toctree-l2"><a class="reference internal" href="91-fast-binary-log-approximations.html">Fast binary log approximations</a></li>
<li class="toctree-l2"><a class="reference internal" href="206-fast-cube-root-square-root-and-reciprocal-for-x86-sse-cpus.html">Fast cube root, square root, and reciprocal for x86/SSE CPUs.</a></li>
<li class="toctree-l2"><a class="reference internal" href="222-fast-exp-approximations.html">Fast exp() approximations</a></li>
<li class="toctree-l2"><a class="reference internal" href="106-fast-exp2-approximation.html">Fast exp2 approximation</a></li>
<li class="toctree-l2"><a class="reference internal" href="63-fast-log2.html">Fast log2</a></li>
<li class="toctree-l2"><a class="reference internal" href="133-fast-power-and-root-estimates-for-32bit-floats.html">Fast power and root estimates for 32bit floats</a></li>
<li class="toctree-l2"><a class="reference internal" href="252-fast-rounding-functions-in-pascal.html">Fast rounding functions in pascal</a></li>
<li class="toctree-l2"><a class="reference internal" href="249-fast-sign-for-32-bit-floats.html">Fast sign for 32 bit floats</a></li>
<li class="toctree-l2"><a class="reference internal" href="56-float-to-int.html">Float to int</a></li>
<li class="toctree-l2"><a class="reference internal" href="170-float-to-int-more-intel-asm.html">Float to int (more intel asm)</a></li>
<li class="toctree-l2"><a class="reference internal" href="246-float-to-integer-conversion.html">Float to integer conversion</a></li>
<li class="toctree-l2"><a class="reference internal" href="57-float-to-int-coverting-an-array-of-floats.html">Float-to-int, coverting an array of floats</a></li>
<li class="toctree-l2"><a class="reference internal" href="121-gaussian-dithering.html">Gaussian dithering</a></li>
<li class="toctree-l2"><a class="reference internal" href="129-gaussian-random-numbers.html">Gaussian random numbers</a></li>
<li class="toctree-l2"><a class="reference internal" href="157-hermite-interpolator-x86-asm.html">Hermite Interpolator (x86 ASM)</a></li>
<li class="toctree-l2"><a class="reference internal" href="93-hermite-interpollation.html">Hermite interpollation</a></li>
<li class="toctree-l2"><a class="reference internal" href="245-linear-interpolation.html">Linear interpolation</a></li>
<li class="toctree-l2"><a class="reference internal" href="119-lock-free-fifo.html">Lock free fifo</a></li>
<li class="toctree-l2"><a class="reference internal" href="58-matlab-tools-for-sndan.html">MATLAB-Tools for SNDAN</a></li>
<li class="toctree-l2"><a class="reference internal" href="125-midi-note-frequency-conversion.html">MIDI note/frequency conversion</a></li>
<li class="toctree-l2"><a class="reference internal" href="188-matlab-time-domain-impulse-response-inverter-divider.html">Matlab Time Domain Impulse Response Inverter/Divider</a></li>
<li class="toctree-l2"><a class="reference internal" href="94-millimeter-to-db-faders.html">Millimeter to DB (faders…)</a></li>
<li class="toctree-l2"><a class="reference internal" href="202-motorola-56300-disassembler.html">Motorola 56300 Disassembler</a></li>
<li class="toctree-l2"><a class="reference internal" href="99-noise-shaping-class.html">Noise Shaping Class</a></li>
<li class="toctree-l2"><a class="reference internal" href="148-nonblocking-multiprocessor-multithread-algorithms-in-c.html">Nonblocking multiprocessor/multithread algorithms in C++</a></li>
<li class="toctree-l2"><a class="reference internal" href="250-piecewise-quadratic-approximate-exponential-function.html">Piecewise quadratic approximate exponential function</a></li>
<li class="toctree-l2"><a class="reference internal" href="55-pow-x-4-approximation.html">Pow(x,4) approximation</a></li>
<li class="toctree-l2"><a class="reference internal" href="238-rational-tanh-approximation.html">Rational tanh approximation</a></li>
<li class="toctree-l2"><a class="reference internal" href="84-reading-the-compressed-wa-parts-in-gigasampler-files.html">Reading the compressed WA! parts in gigasampler files</a></li>
<li class="toctree-l2"><a class="reference internal" href="158-really-fast-x86-floating-point-sin-cos.html">Really fast x86 floating point sin/cos</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Reasonably accurate/fastish tanh approximation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#comments">Comments</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="164-resampling.html">Resampling</a></li>
<li class="toctree-l2"><a class="reference internal" href="120-saturation.html">Saturation</a></li>
<li class="toctree-l2"><a class="reference internal" href="175-sin-x-aproximation-with-sse-code.html">Sin(x) Aproximation (with SSE code)</a></li>
<li class="toctree-l2"><a class="reference internal" href="115-sin-cos-tan-approximation.html">Sin, Cos, Tan approximation</a></li>
<li class="toctree-l2"><a class="reference internal" href="182-vst-sdk-gui-switch-without.html">VST SDK GUI Switch without</a></li>
</ul>
</li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Notebook</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Other</a> &raquo;</li>
        
      <li>Reasonably accurate/fastish tanh approximation</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="reasonably-accurate-fastish-tanh-approximation">
<h1>Reasonably accurate/fastish tanh approximation<a class="headerlink" href="#reasonably-accurate-fastish-tanh-approximation" title="Permalink to this headline">¶</a></h1>
<ul class="simple">
<li><p><strong>Author or source:</strong> Fuzzpilz</p></li>
<li><p><strong>Created:</strong> 2004-08-17 22:56:29</p></li>
</ul>
<div class="literal-block-wrapper docutils container" id="id1">
<div class="code-block-caption"><span class="caption-text">notes</span><a class="headerlink" href="#id1" title="Permalink to this code">¶</a></div>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Fairly obvious, but maybe not obvious enough, since I&#39;ve seen calls to tanh() in code
snippets here.

It&#39;s this, basically:

tanh(x) = sinh(x)/cosh(x)
        = (exp(x) - exp(-x))/(exp(x) + exp(-x))
        = (exp(2x) - 1)/(exp(2x) + 1)

Combine this with a somewhat less accurate approximation for exp than usual (I use a
third-order Taylor approximation below), and you&#39;re set. Useful for waveshaping.

Notes on the exp approximation:

It only works properly for input values above x, but since tanh is odd, that isn&#39;t a
problem.

exp(x) = 1 + x + x^2/(2!) + x^3/(3!) + ...

Breaking the Taylor series off after the third term, I get

1 + x + x^2/2 + x^3/6.

I can save some multiplications by using

6 + x * (6 + x * (3 + x))

instead; a division by 6 becomes necessary, but is lumped into the additions in the tanh
part:

(a/6 - 1)/(a/6 + 1) = (a - 6)/(a + 6).

Accuracy:

I haven&#39;t looked at this in very great detail, but it&#39;s always &lt;= the real tanh (&gt;= for
x&lt;0), and the greatest deviation occurs at about +/- 1.46, where the result is ca. .95
times the correct value.


This is still faster than tanh if you use a better approximation for the exponential, even
if you simply call exp.
There are probably additional ways of improving parts of this, and naturally if you&#39;re
going to use it you&#39;ll want to figure out whether your particular application offers
additional ways of simplifying it, but it&#39;s a good start.
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id2">
<div class="code-block-caption"><span class="caption-text">code</span><a class="headerlink" href="#id2" title="Permalink to this code">¶</a></div>
<div class="highlight-c++ notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cm">/* single precision absolute value, a lot faster than fabsf() (if you use MSVC++ 6 Standard - others&#39; implementations might be less slow) */</span>
<span class="kt">float</span> <span class="nf">sabs</span><span class="p">(</span><span class="kt">float</span> <span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
<span class="kt">int</span> <span class="n">b</span><span class="o">=</span><span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="kt">int</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">a</span><span class="p">)))</span><span class="o">&amp;</span><span class="mh">0x7FFFFFFF</span><span class="p">;</span>
<span class="k">return</span> <span class="o">*</span><span class="p">((</span><span class="kt">float</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">b</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/* approximates tanh(x/2) rather than tanh(x) - depending on how you&#39;re using this, fixing that could well be wasting a multiplication (though that isn&#39;t much, and it could be done with an integer addition in sabs instead)  */</span>
<span class="kt">float</span> <span class="nf">tanh2</span><span class="p">(</span><span class="kt">float</span> <span class="n">x</span><span class="p">)</span>
<span class="p">{</span>
<span class="kt">float</span> <span class="n">a</span><span class="o">=</span><span class="n">sabs</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
<span class="n">a</span><span class="o">=</span><span class="mi">6</span><span class="o">+</span><span class="n">a</span><span class="o">*</span><span class="p">(</span><span class="mi">6</span><span class="o">+</span><span class="n">a</span><span class="o">*</span><span class="p">(</span><span class="mi">3</span><span class="o">+</span><span class="n">a</span><span class="p">));</span>
<span class="k">return</span> <span class="p">((</span><span class="n">x</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span><span class="o">?-</span><span class="mi">1</span><span class="o">:</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">a</span><span class="o">-</span><span class="mi">6</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="mi">6</span><span class="p">);</span> <span class="cm">/* instead of using &lt;, you can also check directly whether the sign bit is set ((*((int *)(&amp;x)))&amp;0x80000000), but it&#39;s not really worth it */</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="comments">
<h2>Comments<a class="headerlink" href="#comments" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p><strong>Date</strong>: 2004-09-19 03:08:02</p></li>
<li><p><strong>By</strong>: <a class="reference external" href="mailto:ten&#46;xmg&#37;&#52;&#48;zlipzzuf">ten<span>&#46;</span>xmg<span>&#64;</span>zlipzzuf</a></p></li>
</ul>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Not sure why this didn&#39;t occur to me earlier, but you can easily save another two adds as follows:

a*=(6+a*(3+a));
return ((x&lt;0)?-1:1)*a/(a+12);
</pre></div>
</div>
<ul class="simple">
<li><p><strong>Date</strong>: 2004-10-06 22:46:23</p></li>
<li><p><strong>By</strong>: <a class="reference external" href="mailto:moc&#46;noicratse&#37;&#52;&#48;ajelak">moc<span>&#46;</span>noicratse<span>&#64;</span>ajelak</a></p></li>
</ul>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>You shouldn&#39;t need the sabs() on VC6 - you just need to add:

#pragma intrinsic( fabs )

before calling fabsf(), and it should go optimally fast.
</pre></div>
</div>
<ul class="simple">
<li><p><strong>Date</strong>: 2004-10-07 10:56:45</p></li>
<li><p><strong>By</strong>: Laurent de Soras</p></li>
</ul>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>You can optimise it a bit more by using the fact that tanh (x) = 1 - 2 / (exp (2*x) + 1)
</pre></div>
</div>
<ul class="simple">
<li><p><strong>Date</strong>: 2004-10-07 11:38:00</p></li>
<li><p><strong>By</strong>: <a class="reference external" href="mailto:ten&#46;xmg&#37;&#52;&#48;zlipzzuf">ten<span>&#46;</span>xmg<span>&#64;</span>zlipzzuf</a></p></li>
</ul>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>AFAIK intrinsics aren&#39;t supported by VC6 Standard, but limited to Professional and Enterprise. Might be wrong, though, in which case I am a silly person. (no time to check now)
</pre></div>
</div>
<ul class="simple">
<li><p><strong>Date</strong>: 2005-03-23 22:48:34</p></li>
<li><p><strong>By</strong>: <a class="reference external" href="mailto:ed&#46;luosfosruoivas&#37;&#52;&#48;naitsirhC">ed<span>&#46;</span>luosfosruoivas<span>&#64;</span>naitsirhC</a></p></li>
</ul>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Delphi Code:

// approximates tanh(x/2) rather than tanh(x) - depending on how you&#39;re using
// this, fixing that could well be wasting a multiplication
function tanh2(x:single):Single;
var a : single;
begin
 a:=f_abs(x);
 a:=a*(12+a*(6+a*(3+a)));
 if (x&lt;0)
  then result:=-a/(a+24)
  else result:= a/(a+24);
end;
</pre></div>
</div>
<ul class="simple">
<li><p><strong>Date</strong>: 2005-03-23 23:01:49</p></li>
<li><p><strong>By</strong>: <a class="reference external" href="mailto:ed&#46;luosfosruoivas&#37;&#52;&#48;naitsirhC">ed<span>&#46;</span>luosfosruoivas<span>&#64;</span>naitsirhC</a></p></li>
</ul>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Laurent de Soras wrote:
&quot;You can optimise it a bit more by using the fact that tanh (x) = 1 - 2 / (exp (2*x) + 1)&quot;

It&#39;s not faster, because you&#39;ll need 3 more cycles. The routine would then look like this:

function tanh2(x:single):Single;
var a : single;
begin
 a:=f_abs(x);
 a:=24+a*(12+a*(6+a*(3+a)));
 if (x&lt;0)
  then result:= (-1+24/a)
  else result:=  (1-24/a);
end;
</pre></div>
</div>
<ul class="simple">
<li><p><strong>Date</strong>: 2005-05-09 02:37:33</p></li>
<li><p><strong>By</strong>: <a class="reference external" href="mailto:eb&#46;tenyks&#37;&#52;&#48;didid">eb<span>&#46;</span>tenyks<span>&#64;</span>didid</a></p></li>
</ul>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>I must have missed this one..
but why is the comparison needed?

a simpler version would be:
a:=Abs(x)
Result:=x*(6+a*(3+a))/(a+12)

no?

So in asm:

function Tanh2(x:Single):Single;
const c3 :Single=3;
      c6 :Single=6;
      c12:Single=12;
Asm
        FLD     x
        FLD     ST(0)
        FABS
        FLD     c3
        FADD    ST(0),ST(1)
        FMUL    ST(0),ST(1)
        FADD    c6
        FMULP   ST(2),ST(0)
        FADD    c12
        FDIVP   ST(1),ST(0)
End;

..but almost all the CPU is wasted by the division anyway
</pre></div>
</div>
<ul class="simple">
<li><p><strong>Date</strong>: 2005-05-09 03:11:16</p></li>
<li><p><strong>By</strong>: <a class="reference external" href="mailto:eb&#46;tenyks&#37;&#52;&#48;didid">eb<span>&#46;</span>tenyks<span>&#64;</span>didid</a></p></li>
</ul>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>wait.. has anyone tested this function?

Here&#39;s a test plot:
http://www.flstudio.com/gol/tanh.gif

Red=TanH

Green=the approximation suggested in this thread

Blue=another approximation that does:

function TanH3(x:Single):Single;
Begin
Result:=x - x*x*x/3 + 2*x*x*x*x*x/15;
end;

If I didn&#39;t do anything wrong, the green one is VERY far from TanH. Blue is both closer &amp; computationally more efficient.

But ok, this plot is for a normalized 0..1. When you go above, the blue like goes crazy.
But now considering that -1..1 is what matters the most for what we do, the input could still be clipped.
</pre></div>
</div>
<ul class="simple">
<li><p><strong>Date</strong>: 2005-05-09 03:23:10</p></li>
<li><p><strong>By</strong>: <a class="reference external" href="mailto:eb&#46;tenyks&#37;&#52;&#48;didid">eb<span>&#46;</span>tenyks<span>&#64;</span>didid</a></p></li>
</ul>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>forget all this :)

it&#39;s all embarrassing bullshit and I obviously need some sleep :)
</pre></div>
</div>
<ul class="simple">
<li><p><strong>Date</strong>: 2005-05-09 03:46:09</p></li>
<li><p><strong>By</strong>: <a class="reference external" href="mailto:eb&#46;tenyks&#37;&#52;&#48;didid">eb<span>&#46;</span>tenyks<span>&#64;</span>didid</a></p></li>
</ul>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Ok ignore my above crap that I can&#39;t delete, I swear that this one does work :)

First I hadn&#39;t seen that this function was assuming x*2, so my graph was scaled by 2..

Second, the other algo (blue line) is still not to be neglected (because no FDIV) when the input is in the -1..1 range, and it does work.

Third, I&#39;m suggesting here a version without the comparison/branching, but still, the CPU difference is neglectable because of the FDIV.


Here it is (this one does NOT assume a premultiplied x)..

plain code:

function Tanh2(x:Single):Single;
var   a,b:Single;
begin
x:=x*2;
a:=abs(x);
b:=(6+a*(3+a));
Result:=(x*b)/(a*b+12);
end;


asm:

function Tanh22(x:Single):Single;
const c3  :Single=3;
      c6  :Single=6;
      c12 :Single=12;
      Mul2:Single=2;
Asm
        FLD     x
        FMUL    Mul2
        FLD     ST(0)
        FABS                 // a
        FLD     c3
        FADD    ST(0),ST(1)
        FMUL    ST(0),ST(1)
        FADD    c6           // b
        FMUL    ST(2),ST(0)  // x*b
        FMULP   ST(1),ST(0)  // a*b
        FADD    c12
        FDIVP   ST(1),ST(0)
End;
</pre></div>
</div>
<ul class="simple">
<li><p><strong>Date</strong>: 2005-05-10 00:37:16</p></li>
<li><p><strong>By</strong>: <a class="reference external" href="mailto:ed&#46;luosfosruoivas&#37;&#52;&#48;naitsirhC">ed<span>&#46;</span>luosfosruoivas<span>&#64;</span>naitsirhC</a></p></li>
</ul>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Any suggestions about improving the 3DNow Divide-Operation??? I simply hate my code...

procedure Transistor2_3DNow(pinp,pout : PSingle; Samples:Integer;Scalar:Single);
const ng   : Array [0..1] of Integer = ($7FFFFFFF,$7FFFFFFF);
      pg   : Array [0..1] of Integer = ($80000000,$80000000);
      c2   : Array [0..1] of Single = (2,2);
      c3   : Array [0..1] of Single = (3,3);
      c6   : Array [0..1] of Single = (6,6);
      c12  : Array [0..1] of Single = (12,12);
      c24  : Array [0..1] of Single = (24,24);
asm
 shr ecx,1
 femms
 movd       mm1, Scalar.Single
 punpckldq  mm1, mm1
 movq       mm0, c2
 pfmul      mm0, mm1

 movq       mm3, c3
 movq       mm4, c6
 movq       mm5, c12
 movq       mm6, c24

@Start:
 movq       mm1, [eax] //mm1=input
 pfmul      mm1, mm0   //mm1=a
 movq       mm2, mm1   //mm1=a,   mm2=a

 pand       mm2, ng    //mm1=a,   mm2=|a|

 pfadd      mm3, c3    //mm1=a,   mm2=|a|, mm3=|a|+3
 pfmul      mm3, mm2   //mm1=a,   mm2=|a|, mm3=|a|*(|a|+3)
 pfadd      mm3, c6    //mm1=a,   mm2=|a|, mm3=6+|a|*(3+|a|)
 pfmul      mm3, mm2   //mm1=a,   mm2=|a|, mm3=|a|*(6+|a|*(3+|a|))
 pfadd      mm3, c12   //mm1=a,   mm2=|a|, mm3=b=12+|a|*(6+|a|*(3+|a|))
 pfmul      mm1, mm3   //mm1=a*b, mm2=|a|, mm3=a*(12+|a|*(6+|a|*(3+|a|)))
 pfmul      mm2, mm3   //mm1=a*b, mm2=|a|*b
 pfadd      mm2, c24   //mm1=a*b, mm2=|a|*b+24


 movq       mm3, mm2
 pfrcp      mm4, mm3
 punpckldq  mm3, mm3
 pfrcpit1   mm3, mm4
 pfrcpit2   mm3, mm4
 movq       mm4, mm2
 punpckhdq  mm4, mm4
 pfrcp      mm5, mm4
 pfrcpit1   mm4, mm5
 pfrcpit2   mm4, mm5
 punpckldq  mm4, mm5
 pfmul      mm1, mm4
 movq       [edx],mm1
 add        eax,8
 add        edx,8
 loop    @Start
 femms
end;
</pre></div>
</div>
<ul class="simple">
<li><p><strong>Date</strong>: 2005-05-10 02:26:36</p></li>
<li><p><strong>By</strong>: <a class="reference external" href="mailto:eb&#46;tenyks&#37;&#52;&#48;didid">eb<span>&#46;</span>tenyks<span>&#64;</span>didid</a></p></li>
</ul>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>mmh why the loop? You can&#39;t process more than 2 Tanh in parallel in this filter, can you?
What CPU gain did you get btw?

Anyway, sucks that 3Dnow doesn&#39;t provide division.. SSE does, though.. DIVPS (or DIVPD to get a double accuracy in this case) would work here. Only problem is that on an AMD I usually get better performances out of 3DNow than SSE/SSE2.
</pre></div>
</div>
<ul class="simple">
<li><p><strong>Date</strong>: 2005-05-10 11:00:10</p></li>
<li><p><strong>By</strong>: <a class="reference external" href="mailto:ed&#46;luosfosruoivas&#37;&#52;&#48;naitsirhC">ed<span>&#46;</span>luosfosruoivas<span>&#64;</span>naitsirhC</a></p></li>
</ul>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>The loop works perfectly well, but it&#39;s of course for Tanh() processing of a whole block instead of inside the moog filter.

The thing, that 3DNow doesn&#39;t provide division really sucks. Anyway, this way i will save a small amount of performance, but it&#39;s not huge. But i believe one can optimize the 12 lines of division further more. Also data prefetching might help a little. Or restructuring, because on AMD the order does matter!

I&#39;ll SSE/SSE2 the code tonight. I think SSE gives a good performance boost, but SSE2 precisition would be needed, if the thing is inside the moog filter (IIR Filter coefficients should allways stay 64bit to avoid digital artifacts).

Cheers,

Christian
</pre></div>
</div>
<ul class="simple">
<li><p><strong>Date</strong>: 2005-05-11 16:41:26</p></li>
<li><p><strong>By</strong>: <a class="reference external" href="mailto:ed&#46;luosfosruoivas&#37;&#52;&#48;naitsirhC">ed<span>&#46;</span>luosfosruoivas<span>&#64;</span>naitsirhC</a></p></li>
</ul>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Here&#39;s the Analog Devices &quot;Sharc&quot; DSP translation of the tanh function (inline processing of register f0):

f11 = 2.;
f0  = f0 * f11;
f11 = abs f0;
f3  = 3.;
f12 = f11+f3;
f12 = f11*f2;
f3  = 6.;
f12 = f12+f3;
f0  = f0*f12;
f12 = f11*f12;
f7  = 12.;
f12 = f12+f3;
f11 = 2.;
f0 = recips f12, f7=f0;
f12=f0*f12;
f7=f0*f7, f0=f11-f12;
f12=f0*f12;
f7=f0*f7, f0=f11-f12;
f12=f0*f12;
rts(db);
f7=f0*f7, f0=f11-f12;
f0=f0*f7;

it can be optimized further more, but hey...
</pre></div>
</div>
<ul class="simple">
<li><p><strong>Date</strong>: 2006-02-25 09:57:21</p></li>
<li><p><strong>By</strong>: Gene</p></li>
</ul>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>tanh(x/2)~ x/(abs(x)+3/(2+x*x))

better...
</pre></div>
</div>
<ul class="simple">
<li><p><strong>Date</strong>: 2006-02-25 11:53:34</p></li>
<li><p><strong>By</strong>: Gene</p></li>
</ul>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>tanh(x/2) ~ x/(abs(x)+2/(2.12-1.44*abs(x)+x*x))

Maximum normalized difference 0.0063 from real tanh (x/2) - good enough now.
</pre></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="164-resampling.html" class="btn btn-neutral float-right" title="Resampling" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="158-really-fast-x86-floating-point-sin-cos.html" class="btn btn-neutral float-left" title="Really fast x86 floating point sin/cos" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Too many to list

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>