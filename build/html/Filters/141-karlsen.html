

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Karlsen &mdash; Notebook  documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Karlsen Fast Ladder" href="240-karlsen-fast-ladder.html" />
    <link rel="prev" title="Hiqh quality /2 decimators" href="231-hiqh-quality-2-decimators.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> Notebook
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../Synthesis/index.html">Synthesis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Analysis/index.html">Analysis</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Filters</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="257-1-pole-lpf-for-smooth-parameter-changes.html">1 pole LPF for smooth parameter changes</a></li>
<li class="toctree-l2"><a class="reference internal" href="185-1-rc-and-c-filter.html">1-RC and C filter</a></li>
<li class="toctree-l2"><a class="reference internal" href="72-18db-oct-resonant-3-pole-lpf-with-tanh-dist.html">18dB/oct resonant 3 pole LPF with tanh() dist</a></li>
<li class="toctree-l2"><a class="reference internal" href="85-1st-and-2nd-order-pink-noise-filters.html">1st and 2nd order pink noise filters</a></li>
<li class="toctree-l2"><a class="reference internal" href="236-3-band-equaliser.html">3 Band Equaliser</a></li>
<li class="toctree-l2"><a class="reference internal" href="30-303-type-filter-with-saturation.html">303 type filter with saturation</a></li>
<li class="toctree-l2"><a class="reference internal" href="266-4th-order-linkwitz-riley-filters.html">4th order Linkwitz-Riley filters</a></li>
<li class="toctree-l2"><a class="reference internal" href="31-all-pass-filters-a-good-explanation.html">All-Pass Filters, a good explanation</a></li>
<li class="toctree-l2"><a class="reference internal" href="181-another-4-pole-lowpass.html">Another 4-pole lowpass…</a></li>
<li class="toctree-l2"><a class="reference internal" href="235-bass-booster.html">Bass Booster</a></li>
<li class="toctree-l2"><a class="reference internal" href="64-biquad-c-code.html">Biquad C code</a></li>
<li class="toctree-l2"><a class="reference internal" href="276-biquad-butterworth-chebyshev-n-order-m-channel-optimized-filters.html">Biquad, Butterworth, Chebyshev N-order, M-channel  optimized filters</a></li>
<li class="toctree-l2"><a class="reference internal" href="243-butterworth-optimized-c-class.html">Butterworth Optimized C++ Class</a></li>
<li class="toctree-l2"><a class="reference internal" href="128-c-class-implementation-of-rbj-filters.html">C++ class implementation of RBJ Filters</a></li>
<li class="toctree-l2"><a class="reference internal" href="226-c-weighed-filter.html">C-Weighed Filter</a></li>
<li class="toctree-l2"><a class="reference internal" href="131-cascaded-resonant-lp-hp-filter.html">Cascaded resonant lp/hp filter</a></li>
<li class="toctree-l2"><a class="reference internal" href="180-cool-sounding-lowpass-with-decibel-measured-resonance.html">Cool Sounding Lowpass With Decibel Measured Resonance</a></li>
<li class="toctree-l2"><a class="reference internal" href="135-dc-filter.html">DC filter</a></li>
<li class="toctree-l2"><a class="reference internal" href="225-delphi-class-implementation-of-the-rbj-filters.html">Delphi Class implementation of the RBJ filters</a></li>
<li class="toctree-l2"><a class="reference internal" href="122-digital-riaa-equalization-filter-coefficients.html">Digital RIAA equalization filter coefficients</a></li>
<li class="toctree-l2"><a class="reference internal" href="275-direct-form-ii-biquad.html">Direct Form II biquad</a></li>
<li class="toctree-l2"><a class="reference internal" href="174-direct-form-ii.html">Direct form II</a></li>
<li class="toctree-l2"><a class="reference internal" href="214-fast-downsampling-with-antialiasing.html">Fast Downsampling With Antialiasing</a></li>
<li class="toctree-l2"><a class="reference internal" href="110-formant-filter.html">Formant filter</a></li>
<li class="toctree-l2"><a class="reference internal" href="179-frequency-warped-fir-lattice.html">Frequency warped FIR lattice</a></li>
<li class="toctree-l2"><a class="reference internal" href="195-hilbert-filter-coefficient-calculation.html">Hilbert Filter Coefficient Calculation</a></li>
<li class="toctree-l2"><a class="reference internal" href="231-hiqh-quality-2-decimators.html">Hiqh quality /2 decimators</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Karlsen</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#comments">Comments</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="240-karlsen-fast-ladder.html">Karlsen Fast Ladder</a></li>
<li class="toctree-l2"><a class="reference internal" href="38-lp-and-hp-filter.html">LP and HP filter</a></li>
<li class="toctree-l2"><a class="reference internal" href="229-lpf-24db-oct.html">LPF 24dB/Oct</a></li>
<li class="toctree-l2"><a class="reference internal" href="28-lowpass-filter-for-parameter-edge-filtering.html">Lowpass filter for parameter edge filtering</a></li>
<li class="toctree-l2"><a class="reference internal" href="270-mdct-and-imdct-based-on-fftw3.html">MDCT and IMDCT based on FFTW3</a></li>
<li class="toctree-l2"><a class="reference internal" href="196-moog-filter.html">Moog Filter</a></li>
<li class="toctree-l2"><a class="reference internal" href="24-moog-vcf.html">Moog VCF</a></li>
<li class="toctree-l2"><a class="reference internal" href="25-moog-vcf-variation-1.html">Moog VCF, variation 1</a></li>
<li class="toctree-l2"><a class="reference internal" href="26-moog-vcf-variation-2.html">Moog VCF, variation 2</a></li>
<li class="toctree-l2"><a class="reference internal" href="35-notch-filter.html">Notch filter</a></li>
<li class="toctree-l2"><a class="reference internal" href="116-one-pole-lp-and-hp.html">One pole LP and HP</a></li>
<li class="toctree-l2"><a class="reference internal" href="237-one-pole-filter-lp-and-hp.html">One pole filter, LP and HP</a></li>
<li class="toctree-l2"><a class="reference internal" href="117-one-pole-one-zero-lp-hp.html">One pole, one zero LP/HP</a></li>
<li class="toctree-l2"><a class="reference internal" href="118-one-zero-lp-hp.html">One zero, LP/HP</a></li>
<li class="toctree-l2"><a class="reference internal" href="263-one-liner-iir-filters-1st-order.html">One-Liner IIR Filters (1st order)</a></li>
<li class="toctree-l2"><a class="reference internal" href="265-output-limiter-using-envelope-follower-in-c.html">Output Limiter using Envelope Follower in C++</a></li>
<li class="toctree-l2"><a class="reference internal" href="130-peak-notch-filter.html">Peak/Notch filter</a></li>
<li class="toctree-l2"><a class="reference internal" href="253-perfect-lp4-filter.html">Perfect LP4 filter</a></li>
<li class="toctree-l2"><a class="reference internal" href="76-pink-noise-filter.html">Pink noise filter</a></li>
<li class="toctree-l2"><a class="reference internal" href="251-plot-filter-analyze-filter-characteristics.html">Plot Filter (Analyze filter characteristics)</a></li>
<li class="toctree-l2"><a class="reference internal" href="218-plotting-r-b-j-equalisers-in-excel.html">Plotting R B-J Equalisers in Excel</a></li>
<li class="toctree-l2"><a class="reference internal" href="39-polyphase-filters.html">Polyphase Filters</a></li>
<li class="toctree-l2"><a class="reference internal" href="223-polyphase-filters-delphi.html">Polyphase Filters (Delphi)</a></li>
<li class="toctree-l2"><a class="reference internal" href="247-poor-man-s-fiwiz.html">Poor Man’s FIWIZ</a></li>
<li class="toctree-l2"><a class="reference internal" href="34-prewarping.html">Prewarping</a></li>
<li class="toctree-l2"><a class="reference internal" href="197-rbj-audio-eq-cookbook.html">RBJ Audio-EQ-Cookbook</a></li>
<li class="toctree-l2"><a class="reference internal" href="198-rbj-audio-eq-cookbook.html">RBJ Audio-EQ-Cookbook</a></li>
<li class="toctree-l2"><a class="reference internal" href="209-remez-exchange-algorithm-parks-mcclellan.html">Remez Exchange Algorithm (Parks/McClellan)</a></li>
<li class="toctree-l2"><a class="reference internal" href="208-remez-remez-parks-mcclellan.html">Remez Remez (Parks/McClellan)</a></li>
<li class="toctree-l2"><a class="reference internal" href="27-resonant-iir-lowpass-12db-oct.html">Resonant IIR lowpass (12dB/oct)</a></li>
<li class="toctree-l2"><a class="reference internal" href="29-resonant-filter.html">Resonant filter</a></li>
<li class="toctree-l2"><a class="reference internal" href="33-resonant-low-pass-filter.html">Resonant low pass filter</a></li>
<li class="toctree-l2"><a class="reference internal" href="176-reverb-filter-generator.html">Reverb Filter Generator</a></li>
<li class="toctree-l2"><a class="reference internal" href="267-simple-tilt-equalizer.html">Simple Tilt equalizer</a></li>
<li class="toctree-l2"><a class="reference internal" href="259-simple-biquad-filter-from-apple-com.html">Simple biquad filter from apple.com</a></li>
<li class="toctree-l2"><a class="reference internal" href="258-spuc-s-open-source-filters.html">Spuc’s open source filters</a></li>
<li class="toctree-l2"><a class="reference internal" href="142-state-variable-filter-chamberlin-version.html">State Variable Filter (Chamberlin version)</a></li>
<li class="toctree-l2"><a class="reference internal" href="92-state-variable-filter-double-sampled-stable.html">State Variable Filter (Double Sampled, Stable)</a></li>
<li class="toctree-l2"><a class="reference internal" href="23-state-variable.html">State variable</a></li>
<li class="toctree-l2"><a class="reference internal" href="145-stilson-s-moog-filter-code.html">Stilson’s Moog filter code</a></li>
<li class="toctree-l2"><a class="reference internal" href="65-time-domain-convolution-with-o-n-log2-3.html">Time domain convolution with O(n^log2(3))</a></li>
<li class="toctree-l2"><a class="reference internal" href="66-time-domain-convolution-with-o-n-log2-3.html">Time domain convolution with O(n^log2(3))</a></li>
<li class="toctree-l2"><a class="reference internal" href="232-type-lpf-24db-oct.html">Type : LPF 24dB/Oct</a></li>
<li class="toctree-l2"><a class="reference internal" href="32-various-biquad-filters.html">Various Biquad filters</a></li>
<li class="toctree-l2"><a class="reference internal" href="194-windowed-sinc-fir-generator.html">Windowed Sinc FIR Generator</a></li>
<li class="toctree-l2"><a class="reference internal" href="37-zoelzer-biquad-filters.html">Zoelzer biquad filters</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../Effects/index.html">Effects</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Other/index.html">Other</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Notebook</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Filters</a> &raquo;</li>
        
      <li>Karlsen</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="karlsen">
<h1>Karlsen<a class="headerlink" href="#karlsen" title="Permalink to this headline">¶</a></h1>
<ul class="simple">
<li><p><strong>Author or source:</strong> Best Regards,Ove Karlsen</p></li>
<li><p><strong>Type:</strong> 24-dB (4-pole) lowpass</p></li>
<li><p><strong>Created:</strong> 2003-04-05 06:57:19</p></li>
</ul>
<div class="literal-block-wrapper docutils container" id="id1">
<div class="code-block-caption"><span class="caption-text">notes</span><a class="headerlink" href="#id1" title="Permalink to this code">¶</a></div>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>There&#39;s really not much voodoo going on in the filter itself, it&#39;s a simple as possible:

pole1 = (in  * frequency) + (pole1 * (1 - frequency));

Most of you can probably understand that math, it&#39;s very similar to how an analog
condenser works.
Although, I did have to do some JuJu to add resonance to it.
While studing the other filters, I found that the feedback phase is very important to how
the overall
resonance level will be, and so I made a dynamic feedback path, and constant Q
approximation by manipulation
of the feedback phase.
A bonus with this filter, is that you can &quot;overdrive&quot; it... Try high input levels..
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id2">
<div class="code-block-caption"><span class="caption-text">code</span><a class="headerlink" href="#id2" title="Permalink to this code">¶</a></div>
<div class="highlight-c++ notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">// Karlsen 24dB Filter by Ove Karlsen / Synergy-7 in the year 2003.</span>
<span class="c1">// b_f = frequency 0..1</span>
<span class="c1">// b_q = resonance 0..50</span>
<span class="c1">// b_in = input</span>
<span class="c1">// to do bandpass, subtract poles from eachother, highpass subtract with input.</span>


   <span class="kt">float</span> <span class="n">b_inSH</span> <span class="o">=</span> <span class="n">b_in</span> <span class="c1">// before the while statement.</span>

    <span class="k">while</span> <span class="p">(</span><span class="n">b_oversample</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>                                              <span class="c1">//2x oversampling (@44.1khz)</span>
            <span class="kt">float</span> <span class="n">prevfp</span><span class="p">;</span>
            <span class="n">prevfp</span> <span class="o">=</span> <span class="n">b_fp</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">prevfp</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span><span class="n">prevfp</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;}</span>                                   <span class="c1">// Q-limiter</span>

            <span class="n">b_fp</span> <span class="o">=</span> <span class="p">(</span><span class="n">b_fp</span> <span class="o">*</span> <span class="mf">0.418</span><span class="p">)</span> <span class="o">+</span> <span class="p">((</span><span class="n">b_q</span> <span class="o">*</span> <span class="n">pole4</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.582</span><span class="p">);</span>                <span class="c1">// dynamic feedback</span>
            <span class="kt">float</span> <span class="n">intfp</span><span class="p">;</span>
            <span class="n">intfp</span> <span class="o">=</span> <span class="p">(</span><span class="n">b_fp</span> <span class="o">*</span> <span class="mf">0.36</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">prevfp</span> <span class="o">*</span> <span class="mf">0.64</span><span class="p">);</span>                        <span class="c1">// feedback phase</span>
            <span class="n">b_in</span> <span class="o">=</span>  <span class="n">b_inSH</span> <span class="o">-</span> <span class="n">intfp</span><span class="p">;</span>                                         <span class="c1">// inverted feedback</span>

            <span class="n">pole1</span> <span class="o">=</span> <span class="p">(</span><span class="n">b_in</span>   <span class="o">*</span> <span class="n">b_f</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">pole1</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">b_f</span><span class="p">));</span>                   <span class="c1">// pole 1</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">pole1</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span><span class="n">pole1</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pole1</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span><span class="n">pole1</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;}</span>  <span class="c1">// pole 1 clipping</span>
            <span class="n">pole2</span> <span class="o">=</span> <span class="p">(</span><span class="n">pole1</span>   <span class="o">*</span> <span class="n">b_f</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">pole2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">b_f</span><span class="p">));</span>                  <span class="c1">// pole 2</span>
            <span class="n">pole3</span> <span class="o">=</span> <span class="p">(</span><span class="n">pole2</span>   <span class="o">*</span> <span class="n">b_f</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">pole3</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">b_f</span><span class="p">));</span>                  <span class="c1">// pole 3</span>
            <span class="n">pole4</span> <span class="o">=</span> <span class="p">(</span><span class="n">pole3</span>   <span class="o">*</span> <span class="n">b_f</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">pole4</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">b_f</span><span class="p">));</span>                  <span class="c1">// pole 4</span>

            <span class="n">b_oversample</span><span class="o">++</span><span class="p">;</span>
            <span class="p">}</span>
    <span class="n">lowpassout</span> <span class="o">=</span> <span class="n">b_in</span><span class="p">;</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="comments">
<h2>Comments<a class="headerlink" href="#comments" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p><strong>Date</strong>: 2003-08-08 18:35:52</p></li>
<li><p><strong>By</strong>: <a class="reference external" href="mailto:moc&#46;7-ygrenys&#37;&#52;&#48;evo">moc<span>&#46;</span>7-ygrenys<span>&#64;</span>evo</a></p></li>
</ul>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Hi.
Seems to be a slight typo in my code.
lowpassout = pole4; // ofcourse :)

Best Regards,
Ove Karlsen
</pre></div>
</div>
<ul class="simple">
<li><p><strong>Date</strong>: 2003-09-20 15:31:19</p></li>
<li><p><strong>By</strong>: <a class="reference external" href="mailto:moc&#46;tidosha&#37;&#52;&#48;ttam">moc<span>&#46;</span>tidosha<span>&#64;</span>ttam</a></p></li>
</ul>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Hi Ove, we spoke once on the #AROS IRC channel... I&#39;m trying to put this code into a filter object, but I&#39;m wandering what datatype the input and output should be?

I&#39;m processing my audio data in packets of 8000 signed words (16 bits) at a time. can I put one audio sample words into this function? Since it seems to require a floating point input!

Thanks
</pre></div>
</div>
<ul class="simple">
<li><p><strong>Date</strong>: 2004-05-17 18:49:43</p></li>
<li><p><strong>By</strong>: <a class="reference external" href="mailto:moc&#46;tsv-nashi&#37;&#52;&#48;edoc_evo">moc<span>&#46;</span>tsv-nashi<span>&#64;</span>edoc_evo</a></p></li>
</ul>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Hi Matt.

Yes, it does indeed need float inputs.

Best Regards,
Ove Karlsen.
</pre></div>
</div>
<ul class="simple">
<li><p><strong>Date</strong>: 2005-03-20 11:36:07</p></li>
<li><p><strong>By</strong>: <a class="reference external" href="mailto:se&#46;arret&#37;&#52;&#48;htrehgraknu">se<span>&#46;</span>arret<span>&#64;</span>htrehgraknu</a></p></li>
</ul>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Can somebody explain exactly howto make the band Pass and high pass, i tried as explained and don&#39;t work exactly as expected

highpass = in  - pole4

make &quot;some kind of highpass&quot;, but not as expected
cut frequency

and for band pass, how we substract the poles between them ?

pole4-pole3-pole2-pole1 ?
pole1-pole2-pole3-pole4 ?

Also, is there a way to get a Notch ?
</pre></div>
</div>
<ul class="simple">
<li><p><strong>Date</strong>: 2005-03-22 14:14:21</p></li>
<li><p><strong>By</strong>: <a class="reference external" href="mailto:ed&#46;luosfosruoivas&#37;&#52;&#48;naitsirhC">ed<span>&#46;</span>luosfosruoivas<span>&#64;</span>naitsirhC</a></p></li>
</ul>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Below you will find an object pascal version of the filter.

L=Lowpass
H=Highpass
N=Notch
B=Bandpass

Regards,

Christian

--
unit KarlsenUnit;

interface

type
  TKarlsen = class
  private
    fQ      : Single;
    fF1,fF  : Single;
    fFS     : Single;
    fTmp    : Double;
    fOS     : Byte;
    fPole   : Array[1..4] of Single;
    procedure SetFrequency(v:Single);
    procedure SetQ(v:Single);
  public
    constructor Create;
    destructor Destroy; override;
    procedure Process(const I : Single; var L,B,N,H: Single);
    property Frequency: Single read fF write SetFrequency;
    property SampleRate: Single read fFS write fFS;
    property Q: Single read fQ write SetQ;
    property OverSample: Byte read fOS write fOS;
  end;

implementation

uses sysutils;

const kDenorm = 1.0e-24;

constructor TKarlsen.Create;
begin
 inherited;
 fFS:=44100;
 Frequency:=1000;
 fOS:=2;
 Q:=1;
end;

destructor TKarlsen.Destroy;
begin
 inherited;
end;

procedure TKarlsen.SetFrequency(v:Single);
begin
 if fFS&lt;=0 then raise exception.create(&#39;Sample Rate Error!&#39;);
 if v&lt;&gt;fF then
  begin
   fF:=v;
   fF1:=fF/fFs; // fF1 range from 0..1
  end;
end;

procedure TKarlsen.SetQ(v:Single);
begin
 if v&lt;&gt;fQ then
  begin
   if v&lt;0  then fQ:=0 else
   if v&gt;50 then fQ:=50 else
   fQ:=v;
  end;
end;

procedure TKarlsen.Process(const I : Single; var L,B,N,H: Single);
var prevfp : Single;
    intfp  : Single;
    o      : Integer;
begin
 for o:=0 to fOS-1 do
  begin
   prevfp:=fTmp;
   if (prevfp &gt; 1) then prevfp:=1; // Q-limiter
   fTmp:=(fTmp*0.418)+((fQ*fPole[4])*0.582); // dynamic feedback
   intfp:=(fTmp*0.36)+(prevfp*0.64); // feedback phase
   fPole[1]:= (((I+kDenorm)-intfp) * fF1) + (fPole[1] * (1 - fF1));
   if (fPole[1] &gt; 1)
    then fPole[1]:= 1
    else if fPole[1] &lt; -1
          then fPole[1]:= -1;
   fPole[2]:=(fPole[1]*fF1)+(fPole[2]*(1-fF1)); // pole 2
   fPole[3]:=(fPole[2]*fF1)+(fPole[3]*(1-fF1)); // pole 3
   fPole[4]:=(fPole[3]*fF1)+(fPole[4]*(1-fF1)); // pole 4
  end;
 L:=fPole[4];
 B:=fPole[4]-fPole[1];
 N:=I-fPole[1];
 H:=I-fPole[4]-fPole[1];
end;

end.
</pre></div>
</div>
<ul class="simple">
<li><p><strong>Date</strong>: 2005-03-29 12:24:17</p></li>
<li><p><strong>By</strong>: <a class="reference external" href="mailto:se&#46;sarret&#37;&#52;&#48;htrehgraknu">se<span>&#46;</span>sarret<span>&#64;</span>htrehgraknu</a></p></li>
</ul>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Thanks Christian!!

Anyway, i tried something similar and seems that what you call Notch is reallya Bandpass and the bandpass makes something really strange

Anyway i&#39;m having  other problems with this filter too. It seems to cut  too Loow for low pass and too high for high pass. Also, resonance sets a peak far away from the cut frequency.And last but not least, the slope isn&#39;t 24 db/oct, realkly is much lesser, but not in a consistent way: sometimes is 6, sometimes 12, sometimes 20, etc

Any ideas ?
</pre></div>
</div>
<ul class="simple">
<li><p><strong>Date</strong>: 2005-07-20 12:28:44</p></li>
<li><p><strong>By</strong>: <a class="reference external" href="mailto:moc&#46;psd-nashi&#37;&#52;&#48;liam">moc<span>&#46;</span>psd-nashi<span>&#64;</span>liam</a></p></li>
</ul>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Your problem sounds a bit strange, maybe you should check your implementation.

Nice to see a pascal version too, Christian!

Although I really recommend one set a lower denormal threshold, maybe a 1/100, it really affects the sound of the filter. The best is probably tweaking that value in realtime to see what sounds best.
Also, doubles for the buffers.. :)

Very Best Regards,
Ove Karlsen
</pre></div>
</div>
<ul class="simple">
<li><p><strong>Date</strong>: 2005-09-20 12:26:37</p></li>
<li><p><strong>By</strong>: <a class="reference external" href="mailto:ku&#46;oc&#46;snosrapsd&#37;&#52;&#48;psdcisum">ku<span>&#46;</span>oc<span>&#46;</span>snosrapsd<span>&#64;</span>psdcisum</a></p></li>
</ul>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Christian, shouldn&#39;t your code end:
L:=fPole[4];
B:=fPole[4]-fPole[1];
//CWB posted
//N:=I-fPole[1];
//B:=I-fPole[4]-fPole[1];

//DSP posted
H:=I-fPole[4]; //Surely pole 4 would give a 24dB/Oct HP, rather than the 6dB version posted
N:=I-fPole[4]-fPole[1]; //Inverse of BP

Any thoughts, anyone?

DSP
</pre></div>
</div>
<ul class="simple">
<li><p><strong>Date</strong>: 2005-09-23 11:15:32</p></li>
<li><p><strong>By</strong>: <a class="reference external" href="mailto:moc&#46;psd-nashi&#37;&#52;&#48;liam">moc<span>&#46;</span>psd-nashi<span>&#64;</span>liam</a></p></li>
</ul>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>This filter was really written mostly to demonstrate the Q-limiter though, and also, to write it in the most computationally effiecent way.
Here is a little more featured version.
---------------------------------------
// Karlsen, Second Order SVF type filter.

// b_in1, b_in2 stereo input
// fvar01 cutoff
// fvar02 slope
// fvar03 mode
// fvar04 res
// fvar05 cutoff/res compensation

// inits, all doubles
//  b_noise = 19.1919191919191919191919191919191919191919;
//  filterbuffers = 0;

    b_noise = b_noise * b_noise;
    int i_noise = b_noise;
    b_noise = b_noise - i_noise;

    double b_lnoise = (b_noise - 0.5) * 2;
    double b_rnoise = ((1-b_noise) - 0.5) * 2;

    b_noise = b_noise + 19;

    b_lnoise = b_lnoise * 65536;
    b_rnoise = b_rnoise * 65536;
    if (b_lnoise &gt; 1) {b_lnoise = 1;} else if (b_lnoise &lt; -1) {b_lnoise = -1;}
    if (b_rnoise &gt; 1) {b_rnoise = 1;} else if (b_rnoise &lt; -1) {b_rnoise = -1;}

    b_lnoise = b_lnoise * 1e-24; // find optimal value
    b_rnoise = b_rnoise * 1e-24;

    b_in1 = b_in1 + (b_lnoise);  // denormal prevention (also doubling as dither and analog noise).
    b_in2 = b_in2 + (b_rnoise);


    float b_slope = (1-fvar2) + 0.5;
    float b_cut = ((fvar1    * fvar1) + ((fvar1 / (b_slope)) * (1 - fvar1))) / ((1 * fvar1) + ((1 / (b_slope)) * (1 - fvar1)));
    b_cut = b_cut*b_cut; // linearize this
    float b_res = fvar4 * 100;
    int i_kmode = fvar3 * 100;

    if (b_cut &gt; 1) {b_cut = 1;}
    if (b_cut &lt; 0) {b_cut = 0;}

    b_in1 = (b_in1 + b_lbuffb1);
    b_in2 = (b_in2 + b_lbuffb2);

    b_lbuf09 = ((b_in1    * b_cut) + ((b_lbuf09 / b_slope) * (1 - b_cut))) / ((1 * b_cut) + ((1 / b_slope) * (1 - b_cut)));
    b_lbuf10 = ((b_in2    * b_cut) + ((b_lbuf10 / b_slope) * (1 - b_cut))) / ((1 * b_cut) + ((1 / b_slope) * (1 - b_cut)));

    b_lbuf11 = ((b_lbuf09    * b_cut) + ((b_lbuf11 / b_slope) * (1 - b_cut))) / ((1 * b_cut) + ((1 / b_slope) * (1 - b_cut)));
    b_lbuf12 = ((b_lbuf10    * b_cut) + ((b_lbuf12 / b_slope) * (1 - b_cut))) / ((1 * b_cut) + ((1 / b_slope) * (1 - b_cut)));

    if (i_kmode == 0) { //lowpass
            b_in1 = b_lbuf11;
            b_in2 = b_lbuf12;
    }
    else if (i_kmode == 1) { // bandpass
            b_in1 = b_lbuf09 - b_lbuf11;
            b_in2 = b_lbuf10 - b_lbuf12;
    }
    else if (i_kmode == 2) { // highpass
            b_in1 = b_in1 - b_lbuf11;
            b_in2 = b_in2 - b_lbuf12;
    }

    b_lbuffb1 = ((b_lbuf09 - b_lbuf11) * ((b_cut * fvar5) + 1)) * b_res;
    b_lbuffb2 = ((b_lbuf10 - b_lbuf12) * ((b_cut * fvar5) + 1)) * b_res;

    b_lbuffb1 = atan(b_lbuffb1);
    b_lbuffb2 = atan(b_lbuffb2);
---------------------------------------------
Works really well with control signals, where you keep the cutoff at a constant level.
Also, a bit more useful with audio, if you linearize the cutoff.

Best Regards,
Ove Karlsen.
</pre></div>
</div>
<ul class="simple">
<li><p><strong>Date</strong>: 2005-10-13 14:00:39</p></li>
<li><p><strong>By</strong>: <a class="reference external" href="mailto:ku&#46;oc&#46;snosrapsd&#37;&#52;&#48;psdcisum">ku<span>&#46;</span>oc<span>&#46;</span>snosrapsd<span>&#64;</span>psdcisum</a></p></li>
</ul>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>I was looking at the b_cut assignment, and was going through looking
at optimising it and found this:

float b_cut = ((fvar1    * fvar1) + ((fvar1 / (b_slope)) * (1 - fvar1)))
/ ((1 * fvar1) + ((1 / (b_slope)) * (1 - fvar1)));

Rename for convenience and clarity
fvar1=co
b_slope=sl

=&gt; (co^2+(co(1-co)))
          --------
             sl
    ---------------
     (1*co)+(1-co)
             ----
              sl

multiply numerator &amp; denominator by sl to even things up

=&gt; (sl*co^2+(co(1-co)))
    ------------------
      (sl*co)+(1-co)

expand brackets

=&gt;  sl*co^2+co-co^2
    ---------------
      sl*co+1-co

refactor

=&gt;  co(sl*co+1-co)
    ---------------
      sl*co+1-co

(sl*co+1-co) cancels out, leaving..

=&gt; co


if I&#39;ve got anything wrong here, please pipe up..

Duncan
</pre></div>
</div>
<ul class="simple">
<li><p><strong>Date</strong>: 2005-10-13 14:06:02</p></li>
<li><p><strong>By</strong>: <a class="reference external" href="mailto:ku&#46;oc&#46;snosrapsd&#37;&#52;&#48;psdcisum">ku<span>&#46;</span>oc<span>&#46;</span>snosrapsd<span>&#64;</span>psdcisum</a></p></li>
</ul>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>(actually, typing the assigment into Excel reveals the same as my proof..)
</pre></div>
</div>
<ul class="simple">
<li><p><strong>Date</strong>: 2006-02-17 13:23:47</p></li>
<li><p><strong>By</strong>: <a class="reference external" href="mailto:moc&#46;psd-nashi&#37;&#52;&#48;liam">moc<span>&#46;</span>psd-nashi<span>&#64;</span>liam</a></p></li>
</ul>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Final version, Stenseth, 17. february, 2006.

// Fast differential amplifier approximation

    double b_inr = b_in * b_filterdrive;
    if (b_inr &lt; 0) {b_inr = -b_inr;}
    double b_inrns = b_inr;
    if (b_inr &gt; 1) {b_inr = 1;}
    double b_dax = b_inr - ((b_inr * b_inr) * 0.5);
    b_dax = b_dax - b_inr;
    b_inr = b_inr + b_dax;

    b_inr = b_inr * 0.24;

    if (b_inr &gt; 1) {b_inr = 1;}
    b_dax = b_inr - ((b_inr * 0.33333333) * (b_inr * b_inr));
    b_dax = b_dax - b_inr;
    b_inr = b_inr + b_dax;

    b_inr = b_inr / 0.24;

    double b_mul = b_inrns / b_inr; // beware of zero
    b_sbuf1 = ((b_sbuf1 - (b_sbuf1 * 0.4300)) + (b_mul * 0.4300));

    b_mul = b_sbuf1 + ((b_mul - b_sbuf1) * 0.6910);
    b_in = b_in / b_mul;

// This method sounds the best here..
// About denormals, it does not seem to be much of an issue here, probably because I input the filters with oscillators, and not samples, or other, where the level may drop below the denormal threshold for extended periods of time. However, if you do, you probably want to quantize out the information below the threshold, in the buffers, and raise/lower the inputlevel before/after the filter. Adding low levels of noise may be effective aswell. This is described somewhere else on this site.

    double b_cutsc = pow(1024,b_cut) / 1024; // perfect tracking..

    b_fbuf1 = ((b_fbuf1 - (b_fbuf1 * b_cutsc)) + (b_in * b_cutsc));
    b_in = b_fbuf1;
    b_fbuf2 = ((b_fbuf2 - (b_fbuf2 * b_cutsc)) + (b_in * b_cutsc));
    b_in = b_fbuf2;
    b_fbuf3 = ((b_fbuf3 - (b_fbuf3 * b_cutsc)) + (b_in * b_cutsc));
    b_in = b_fbuf3;
    b_fbuf4 = ((b_fbuf4 - (b_fbuf4 * b_cutsc)) + (b_in * b_cutsc));
    b_in = b_fbuf4;

Soundwise, it&#39;s somewhere between a transistor ladder, and a diode ladder..
Enjoy!

Ove Karlsen.
PS: I prefer IRL communication these days, so if you need to reach me, please dial my cellphone, +047 928 50 803.
</pre></div>
</div>
<ul class="simple">
<li><p><strong>Date</strong>: 2006-11-03 03:51:29</p></li>
<li><p><strong>By</strong>: <a class="reference external" href="mailto:read&#37;&#52;&#48;bw">read<span>&#64;</span>bw</a></p></li>
</ul>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Another iteration, please delete all other posts than this.

Arif Ove Karlsen&#39;s 24dB Ladder Approximation, 3.nov 2007

As you may know, The traditional 4-pole Ladder found in vintage hardware synths,
had a particular sound. The nonlinearities inherent in the suboptimal components, often
added a particular flavour to the sound.
Digital does mathematical calculations much better than any analog solution, and therefore, when the filter was emulated by digital filter types, some of the character got lost.
I believe this mainly boils down to the resonance limiting occuring in the analog version.
Therefore I have written a very fast ladder approximation, not emulating any of what may seem neccesary, such as pole saturaion, which in turn results in nonlinear cutoff frequency, and loss of volume at lower cutoffs. However this can be implemented, if wanted, by putting the neccesary saturation functions inside the code. If you seek the true analog sound, you may want to do a full differential amplifier emulation aswell.
But - I believe in the end, you would end up wanting a perfect filter, with just the touch that makes it sound analog, resonance limiting.

So here it is, Karlsen Ladder, v4. A very resource effiecent ladder. Can furthermore be optimized with asm.

rez = pole4 * rezamount; if (rez &gt; 1) {rez = 1;}
input = input - rez;
pole1 = pole1 + ((-pole1 + input) * cutoffreq);
pole2 = pole2 + ((-pole2 + pole1) * cutoffreq);
pole3 = pole3 + ((-pole3 + pole2) * cutoffreq);
pole4 = pole4 + ((-pole4 + pole3) * cutoffreq);
output = pole4;

--

I can be reached by email @ 1a2r4i54f5o5v2ek1a1r5ls6en@3ho2tm6ail1.c5o6m!no!nums
</pre></div>
</div>
<ul class="simple">
<li><p><strong>Date</strong>: 2013-06-21 14:42:33</p></li>
<li><p><strong>By</strong>: <a class="reference external" href="mailto:pleasee&#37;&#52;&#48;otherpost">pleasee<span>&#64;</span>otherpost</a></p></li>
</ul>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Please see
              http://musicdsp.org/showArchiveComment.php?ArchiveID=240

for the ultimate development of this filter.

Peace Be With You,
Ove Karlsen
</pre></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="240-karlsen-fast-ladder.html" class="btn btn-neutral float-right" title="Karlsen Fast Ladder" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="231-hiqh-quality-2-decimators.html" class="btn btn-neutral float-left" title="Hiqh quality /2 decimators" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Too many to list

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>