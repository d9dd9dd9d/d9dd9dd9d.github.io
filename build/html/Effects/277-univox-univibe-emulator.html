

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>UniVox Univibe Emulator &mdash; Musicdsp.org  documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Variable-hardness clipping function" href="104-variable-hardness-clipping-function.html" />
    <link rel="prev" title="Transistor differential amplifier simulation" href="177-transistor-differential-amplifier-simulation.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> Musicdsp.org
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../Synthesis/index.html">Synthesis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Analysis/index.html">Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Filters/index.html">Filters</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Effects</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="89-2-wave-shaping-things.html">2 Wave shaping things</a></li>
<li class="toctree-l2"><a class="reference internal" href="70-alien-wah.html">Alien Wah</a></li>
<li class="toctree-l2"><a class="reference internal" href="221-band-limited-pwm-generator.html">Band Limited PWM Generator</a></li>
<li class="toctree-l2"><a class="reference internal" href="96-bit-quantization-reduction-effect.html">Bit quantization/reduction effect</a></li>
<li class="toctree-l2"><a class="reference internal" href="98-class-for-waveguide-delay-effects.html">Class for waveguide/delay effects</a></li>
<li class="toctree-l2"><a class="reference internal" href="169-compressor.html">Compressor</a></li>
<li class="toctree-l2"><a class="reference internal" href="124-decimator.html">Decimator</a></li>
<li class="toctree-l2"><a class="reference internal" href="44-delay-time-calculation-for-reverberation.html">Delay time calculation for reverberation</a></li>
<li class="toctree-l2"><a class="reference internal" href="207-dynamic-convolution.html">Dynamic convolution</a></li>
<li class="toctree-l2"><a class="reference internal" href="102-ece320-project-reverberation-w-parameter-control-from-pc.html">ECE320 project: Reverberation w/ parameter control from PC</a></li>
<li class="toctree-l2"><a class="reference internal" href="74-early-echo-s-with-image-mirror-technique.html">Early echo’s with image-mirror technique</a></li>
<li class="toctree-l2"><a class="reference internal" href="203-fold-back-distortion.html">Fold back distortion</a></li>
<li class="toctree-l2"><a class="reference internal" href="47-guitar-feedback.html">Guitar feedback</a></li>
<li class="toctree-l2"><a class="reference internal" href="139-lo-fi-crusher.html">Lo-Fi Crusher</a></li>
<li class="toctree-l2"><a class="reference internal" href="274-lookahead-limiter.html">Lookahead Limiter</a></li>
<li class="toctree-l2"><a class="reference internal" href="154-most-simple-and-smooth-feedback-delay.html">Most simple and smooth feedback delay</a></li>
<li class="toctree-l2"><a class="reference internal" href="153-most-simple-static-delay.html">Most simple static delay</a></li>
<li class="toctree-l2"><a class="reference internal" href="101-parallel-combs-delay-calculation.html">Parallel combs delay calculation</a></li>
<li class="toctree-l2"><a class="reference internal" href="78-phaser-code.html">Phaser code</a></li>
<li class="toctree-l2"><a class="reference internal" href="230-polynominal-waveshaper.html">Polynominal Waveshaper</a></li>
<li class="toctree-l2"><a class="reference internal" href="150-reverberation-algorithms-in-matlab.html">Reverberation Algorithms in Matlab</a></li>
<li class="toctree-l2"><a class="reference internal" href="45-reverberation-techniques.html">Reverberation techniques</a></li>
<li class="toctree-l2"><a class="reference internal" href="204-simple-compressor-class-c.html">Simple Compressor class (C++)</a></li>
<li class="toctree-l2"><a class="reference internal" href="42-soft-saturation.html">Soft saturation</a></li>
<li class="toctree-l2"><a class="reference internal" href="173-stereo-enhancer.html">Stereo Enhancer</a></li>
<li class="toctree-l2"><a class="reference internal" href="255-stereo-field-rotation-via-transformation-matrix.html">Stereo Field Rotation Via Transformation Matrix</a></li>
<li class="toctree-l2"><a class="reference internal" href="256-stereo-width-control-obtained-via-transfromation-matrix.html">Stereo Width Control (Obtained Via Transfromation Matrix)</a></li>
<li class="toctree-l2"><a class="reference internal" href="126-time-compression-expansion-using-standard-phase-vocoder.html">Time compression-expansion using standard phase vocoder</a></li>
<li class="toctree-l2"><a class="reference internal" href="177-transistor-differential-amplifier-simulation.html">Transistor differential amplifier simulation</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">UniVox Univibe Emulator</a></li>
<li class="toctree-l2"><a class="reference internal" href="104-variable-hardness-clipping-function.html">Variable-hardness clipping function</a></li>
<li class="toctree-l2"><a class="reference internal" href="41-waveshaper.html">WaveShaper</a></li>
<li class="toctree-l2"><a class="reference internal" href="43-waveshaper.html">Waveshaper</a></li>
<li class="toctree-l2"><a class="reference internal" href="46-waveshaper.html">Waveshaper</a></li>
<li class="toctree-l2"><a class="reference internal" href="114-waveshaper-simple-description.html">Waveshaper (simple description)</a></li>
<li class="toctree-l2"><a class="reference internal" href="86-waveshaper-gloubi-boulga.html">Waveshaper :: Gloubi-boulga</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../Other/index.html">Other</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Musicdsp.org</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Effects</a> &raquo;</li>
        
      <li>UniVox Univibe Emulator</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/Effects/277-univox-univibe-emulator.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="univox-univibe-emulator">
<h1>UniVox Univibe Emulator<a class="headerlink" href="#univox-univibe-emulator" title="Permalink to this headline">¶</a></h1>
<ul class="simple">
<li><p><strong>Author or source:</strong> <a class="reference external" href="mailto:moc&#46;liamg&#37;&#52;&#48;libojyr">moc<span>&#46;</span>liamg<span>&#64;</span>libojyr</a></p></li>
<li><p><strong>Type:</strong> 4 Cascaded all-pass filters and optocoupler approximation</p></li>
<li><p><strong>Created:</strong> 2010-09-09 07:52:24</p></li>
</ul>
<div class="literal-block-wrapper docutils container" id="id1">
<div class="code-block-caption"><span class="caption-text">notes</span><a class="headerlink" href="#id1" title="Permalink to this code">¶</a></div>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>This is a class and class member functions for a &#39;Vibe derived by means of bilinear
transform of the all-pass filter stages in a UniVibe.  Some unique things happen as this
filter is modulated, so this has been somewhat involved computation of filter
coefficients, and is based on summation of 1rst-order filter stages as algebraically
decoupled during circuit analysis.  A second part is an approximated model of the Vactrol
used to modulate the filters, including its time response to hopefully recapture the
modulation shape.  It is likely there is a more efficient way to re-create the LFO shape,
and perhaps would be best with a lookup table.   Keeping the calculation in the code makes
it possible for other people to modify and improve the algorithm.

Notice no wet/dry mix is implemented in this code block&#39;s &quot;out&quot; function.  Originally this
was implemented in the calling routine, but if you use it as a stand-alone function you
may want to add summation to the input signal as it is an important part of the &quot;chorus&quot;
mode on the Vibe.  The code as is represents only the Vibrato (warble) mode.

This is a module found in the Rakarrack guitar effects program.  It is GPL, so please give
credit due and keep it free.  You can find any of the omitted parts to see more precisely
how it is implemented with JACK on Linux by looking at the original sources at
sourceforge.net/projects/rakarrack.
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id2">
<div class="code-block-caption"><span class="caption-text">code</span><a class="headerlink" href="#id2" title="Permalink to this code">¶</a></div>
<div class="highlight-c++ notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
374
375
376
377
378
379
380
381
382
383
384
385
386
387
388
389
390
391
392
393
394
395
396
397
398
399
400
401
402
403
404
405
406
407
408
409
410
411
412
413
414
415
416
417
418
419
420
421
422
423
424
425
426
427
428</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cm">/*</span>
<span class="cm">  Copyright (C) 2008-2010 Ryan Billing</span>
<span class="cm">  Author: Ryan Billing</span>


<span class="cm"> This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> it under the terms of version 2 of the GNU General Public License</span>
<span class="cm"> as published by the Free Software Foundation.</span>

<span class="cm"> This program is distributed in the hope that it will be useful,</span>
<span class="cm"> but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> GNU General Public License (version 2) for more details.</span>

<span class="cm"> You should have received a copy of the GNU General Public License</span>
<span class="cm"> (version2)  along with this program; if not, write to the Free Software</span>
<span class="cm"> Foundation,</span>
<span class="cm"> Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA</span>

<span class="cm">*/</span>

<span class="k">class</span> <span class="nc">Vibe</span>
<span class="p">{</span>

<span class="k">public</span><span class="o">:</span>

  <span class="n">Vibe</span> <span class="p">(</span><span class="kt">float</span> <span class="o">*</span> <span class="n">efxoutl_</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span> <span class="n">efxoutr_</span><span class="p">);</span>
  <span class="o">~</span><span class="n">Vibe</span> <span class="p">();</span>
<span class="c1">//note some of these functions not pasted below to improve clarity</span>
<span class="c1">//and to save space</span>
  <span class="kt">void</span> <span class="nf">out</span> <span class="p">(</span><span class="kt">float</span> <span class="o">*</span> <span class="n">smpsl</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span> <span class="n">smpsr</span><span class="p">);</span>
  <span class="kt">void</span> <span class="nf">setvolume</span><span class="p">(</span><span class="kt">int</span> <span class="n">value</span><span class="p">);</span>
  <span class="kt">void</span> <span class="nf">setpanning</span><span class="p">(</span><span class="kt">int</span> <span class="n">value</span><span class="p">);</span>
  <span class="kt">void</span> <span class="nf">setpreset</span> <span class="p">(</span><span class="kt">int</span> <span class="n">npreset</span><span class="p">);</span>
  <span class="kt">void</span> <span class="nf">changepar</span> <span class="p">(</span><span class="kt">int</span> <span class="n">npar</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">);</span>
  <span class="kt">int</span> <span class="nf">getpar</span> <span class="p">(</span><span class="kt">int</span> <span class="n">npar</span><span class="p">);</span>
  <span class="kt">void</span> <span class="nf">cleanup</span> <span class="p">();</span>

  <span class="kt">float</span> <span class="n">outvolume</span><span class="p">;</span>
  <span class="kt">float</span> <span class="o">*</span><span class="n">efxoutl</span><span class="p">;</span>
  <span class="kt">float</span> <span class="o">*</span><span class="n">efxoutr</span><span class="p">;</span>


<span class="k">private</span><span class="o">:</span>
  <span class="kt">int</span> <span class="n">Pwidth</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">Pfb</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">Plrcross</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">Pdepth</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">Ppanning</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">Pvolume</span><span class="p">;</span>
   <span class="c1">//all the ints above are the parameters to modify with a proper function.</span>

  <span class="kt">float</span> <span class="n">fwidth</span><span class="p">;</span>
  <span class="kt">float</span> <span class="n">fdepth</span><span class="p">;</span>
  <span class="kt">float</span> <span class="n">rpanning</span><span class="p">,</span> <span class="n">lpanning</span><span class="p">;</span>
  <span class="kt">float</span> <span class="n">flrcross</span><span class="p">,</span> <span class="n">fcross</span><span class="p">;</span>
  <span class="kt">float</span> <span class="n">fb</span><span class="p">;</span>
  <span class="n">EffectLFO</span> <span class="n">lfo</span><span class="p">;</span> <span class="c1">//EffectLFO is an object that calculates the next sample from the LFO each time it&#39;s called</span>

  <span class="kt">float</span> <span class="n">Ra</span><span class="p">,</span> <span class="n">Rb</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">dTC</span><span class="p">,</span> <span class="n">dRCl</span><span class="p">,</span> <span class="n">dRCr</span><span class="p">,</span> <span class="n">lampTC</span><span class="p">,</span> <span class="n">ilampTC</span><span class="p">,</span> <span class="n">minTC</span><span class="p">,</span> <span class="n">alphal</span><span class="p">,</span> <span class="n">alphar</span><span class="p">,</span> <span class="n">stepl</span><span class="p">,</span> <span class="n">stepr</span><span class="p">,</span> <span class="n">oldstepl</span><span class="p">,</span> <span class="n">oldstepr</span><span class="p">;</span>
  <span class="kt">float</span> <span class="n">fbr</span><span class="p">,</span> <span class="n">fbl</span><span class="p">;</span>
  <span class="kt">float</span> <span class="n">dalphal</span><span class="p">,</span> <span class="n">dalphar</span><span class="p">;</span>
  <span class="kt">float</span> <span class="n">lstep</span><span class="p">,</span><span class="n">rstep</span><span class="p">;</span>
  <span class="kt">float</span> <span class="n">cperiod</span><span class="p">;</span>
  <span class="kt">float</span> <span class="n">gl</span><span class="p">,</span> <span class="n">oldgl</span><span class="p">;</span>
  <span class="kt">float</span> <span class="n">gr</span><span class="p">,</span> <span class="n">oldgr</span><span class="p">;</span>

  <span class="k">class</span> <span class="nc">fparams</span> <span class="p">{</span>
  <span class="k">public</span><span class="o">:</span>
  <span class="kt">float</span> <span class="n">x1</span><span class="p">;</span>
  <span class="kt">float</span> <span class="n">y1</span><span class="p">;</span>
  <span class="c1">//filter coefficients</span>
  <span class="kt">float</span> <span class="n">n0</span><span class="p">;</span>
  <span class="kt">float</span> <span class="n">n1</span><span class="p">;</span>
  <span class="kt">float</span> <span class="n">d0</span><span class="p">;</span>
  <span class="kt">float</span> <span class="n">d1</span><span class="p">;</span>
  <span class="p">}</span> <span class="n">vc</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="n">vcvo</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="n">ecvc</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="n">vevo</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="n">bootstrap</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>

  <span class="kt">float</span> <span class="nf">vibefilter</span><span class="p">(</span><span class="kt">float</span> <span class="n">data</span><span class="p">,</span> <span class="n">fparams</span> <span class="o">*</span><span class="n">ftype</span><span class="p">,</span> <span class="kt">int</span> <span class="n">stage</span><span class="p">);</span>
  <span class="kt">void</span> <span class="nf">init_vibes</span><span class="p">();</span>
  <span class="kt">void</span> <span class="nf">modulate</span><span class="p">(</span><span class="kt">float</span> <span class="n">ldrl</span><span class="p">,</span> <span class="kt">float</span> <span class="n">ldrr</span><span class="p">);</span>
  <span class="kt">float</span> <span class="nf">bjt_shape</span><span class="p">(</span><span class="kt">float</span> <span class="n">data</span><span class="p">);</span>

<span class="kt">float</span> <span class="n">R1</span><span class="p">;</span>
<span class="kt">float</span> <span class="n">Rv</span><span class="p">;</span>
<span class="kt">float</span> <span class="n">C2</span><span class="p">;</span>
<span class="kt">float</span> <span class="n">C1</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
<span class="kt">float</span> <span class="n">beta</span><span class="p">;</span>  <span class="c1">//transistor forward gain.</span>
<span class="kt">float</span> <span class="n">gain</span><span class="p">,</span> <span class="n">k</span><span class="p">;</span>
<span class="kt">float</span> <span class="n">oldcvolt</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="p">;</span>
<span class="kt">float</span> <span class="n">en1</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="n">en0</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="n">ed1</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="n">ed0</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
<span class="kt">float</span> <span class="n">cn1</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="n">cn0</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="n">cd1</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="n">cd0</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
<span class="kt">float</span> <span class="n">ecn1</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="n">ecn0</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="n">ecd1</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="n">ecd0</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
<span class="kt">float</span> <span class="n">on1</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="n">on0</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="n">od1</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="n">od0</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>

   <span class="k">class</span> <span class="nc">FPreset</span> <span class="o">*</span><span class="n">Fpre</span><span class="p">;</span>


<span class="p">};</span>


<span class="n">Vibe</span><span class="o">::</span><span class="n">Vibe</span> <span class="p">(</span><span class="kt">float</span> <span class="o">*</span> <span class="n">efxoutl_</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span> <span class="n">efxoutr_</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">efxoutl</span> <span class="o">=</span> <span class="n">efxoutl_</span><span class="p">;</span>
  <span class="n">efxoutr</span> <span class="o">=</span> <span class="n">efxoutr_</span><span class="p">;</span>

<span class="c1">//Swing was measured on operating device of: 10K to 250k.</span>
<span class="c1">//400K is reported to sound better for the &quot;low end&quot; (high resistance)</span>
<span class="c1">//Because of time response, Rb needs to be driven further.</span>
<span class="c1">//End resistance will max out to around 10k for most LFO freqs.</span>
<span class="c1">//pushing low end a little lower for kicks and giggles</span>
<span class="n">Ra</span> <span class="o">=</span> <span class="mf">500000.0f</span><span class="p">;</span>  <span class="c1">//Cds cell dark resistance.</span>
<span class="n">Ra</span> <span class="o">=</span> <span class="n">logf</span><span class="p">(</span><span class="n">Ra</span><span class="p">);</span>              <span class="c1">//this is done for clarity</span>
<span class="n">Rb</span> <span class="o">=</span> <span class="mf">600.0f</span><span class="p">;</span>         <span class="c1">//Cds cell full illumination</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">exp</span><span class="p">(</span><span class="n">Ra</span><span class="o">/</span><span class="n">logf</span><span class="p">(</span><span class="n">Rb</span><span class="p">))</span> <span class="o">-</span> <span class="n">CNST_E</span><span class="p">;</span>
<span class="n">dTC</span> <span class="o">=</span> <span class="mf">0.085f</span><span class="p">;</span>
<span class="n">dRCl</span> <span class="o">=</span> <span class="n">dTC</span><span class="p">;</span>
<span class="n">dRCr</span> <span class="o">=</span> <span class="n">dTC</span><span class="p">;</span>   <span class="c1">//Right &amp; left channel dynamic time contsants</span>
<span class="n">minTC</span> <span class="o">=</span> <span class="n">logf</span><span class="p">(</span><span class="mf">0.005f</span><span class="o">/</span><span class="n">dTC</span><span class="p">);</span>
<span class="c1">//cSAMPLE_RATE is 1/SAMPLE_RATE</span>
<span class="n">alphal</span> <span class="o">=</span> <span class="mf">1.0f</span> <span class="o">-</span> <span class="n">cSAMPLE_RATE</span><span class="o">/</span><span class="p">(</span><span class="n">dRCl</span> <span class="o">+</span> <span class="n">cSAMPLE_RATE</span><span class="p">);</span>
<span class="n">alphar</span> <span class="o">=</span> <span class="n">alphal</span><span class="p">;</span>
<span class="n">dalphal</span> <span class="o">=</span> <span class="n">dalphar</span> <span class="o">=</span> <span class="n">alphal</span><span class="p">;</span>
<span class="n">lampTC</span> <span class="o">=</span> <span class="n">cSAMPLE_RATE</span><span class="o">/</span><span class="p">(</span><span class="mf">0.02</span> <span class="o">+</span> <span class="n">cSAMPLE_RATE</span><span class="p">);</span>  <span class="c1">//guessing 10ms</span>
<span class="n">ilampTC</span> <span class="o">=</span> <span class="mf">1.0f</span> <span class="o">-</span> <span class="n">lampTC</span><span class="p">;</span>
<span class="n">lstep</span> <span class="o">=</span> <span class="mf">0.0f</span><span class="p">;</span>
<span class="n">rstep</span> <span class="o">=</span> <span class="mf">0.0f</span><span class="p">;</span>
<span class="n">Pdepth</span> <span class="o">=</span> <span class="mi">127</span><span class="p">;</span>
<span class="n">Ppanning</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
<span class="n">lpanning</span> <span class="o">=</span> <span class="mf">1.0f</span><span class="p">;</span>
<span class="n">rpanning</span> <span class="o">=</span> <span class="mf">1.0f</span><span class="p">;</span>
<span class="n">fdepth</span> <span class="o">=</span> <span class="mf">1.0f</span><span class="p">;</span>
<span class="n">oldgl</span> <span class="o">=</span> <span class="mf">0.0f</span><span class="p">;</span>
<span class="n">oldgr</span> <span class="o">=</span> <span class="mf">0.0f</span><span class="p">;</span>
<span class="n">gl</span> <span class="o">=</span> <span class="mf">0.0f</span><span class="p">;</span>
<span class="n">gr</span> <span class="o">=</span> <span class="mf">0.0f</span><span class="p">;</span>
<span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">jj</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">jj</span><span class="o">&lt;</span><span class="mi">8</span><span class="p">;</span> <span class="n">jj</span><span class="o">++</span><span class="p">)</span> <span class="n">oldcvolt</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0f</span><span class="p">;</span>
<span class="n">cperiod</span> <span class="o">=</span> <span class="mf">1.0f</span><span class="o">/</span><span class="n">fPERIOD</span><span class="p">;</span>

<span class="n">init_vibes</span><span class="p">();</span>
<span class="n">cleanup</span><span class="p">();</span>

<span class="p">}</span>

<span class="n">Vibe</span><span class="o">::~</span><span class="n">Vibe</span> <span class="p">()</span>
<span class="p">{</span>
<span class="p">}</span>


<span class="kt">void</span>
<span class="n">Vibe</span><span class="o">::</span><span class="n">cleanup</span> <span class="p">()</span>
<span class="p">{</span>
<span class="c1">//Yeah, clean up some stuff</span>

<span class="p">};</span>

<span class="kt">void</span>
<span class="n">Vibe</span><span class="o">::</span><span class="n">out</span> <span class="p">(</span><span class="kt">float</span> <span class="o">*</span><span class="n">smpsl</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="n">smpsr</span><span class="p">)</span>
<span class="p">{</span>

  <span class="kt">int</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">;</span>
  <span class="kt">float</span> <span class="n">lfol</span><span class="p">,</span> <span class="n">lfor</span><span class="p">,</span> <span class="n">xl</span><span class="p">,</span> <span class="n">xr</span><span class="p">,</span> <span class="n">fxl</span><span class="p">,</span> <span class="n">fxr</span><span class="p">;</span>
  <span class="kt">float</span> <span class="n">vbe</span><span class="p">,</span><span class="n">vin</span><span class="p">;</span>
  <span class="kt">float</span> <span class="n">cvolt</span><span class="p">,</span> <span class="n">ocvolt</span><span class="p">,</span> <span class="n">evolt</span><span class="p">,</span> <span class="n">input</span><span class="p">;</span>
  <span class="kt">float</span> <span class="n">emitterfb</span> <span class="o">=</span> <span class="mf">0.0f</span><span class="p">;</span>
  <span class="kt">float</span> <span class="n">outl</span><span class="p">,</span> <span class="n">outr</span><span class="p">;</span>

  <span class="n">input</span> <span class="o">=</span> <span class="n">cvolt</span> <span class="o">=</span> <span class="n">ocvolt</span> <span class="o">=</span> <span class="n">evolt</span> <span class="o">=</span> <span class="mf">0.0f</span><span class="p">;</span>

  <span class="n">lfo</span><span class="p">.</span><span class="n">effectlfoout</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">lfol</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lfor</span><span class="p">);</span>

  <span class="n">lfol</span> <span class="o">=</span> <span class="n">fdepth</span> <span class="o">+</span> <span class="n">lfol</span><span class="o">*</span><span class="n">fwidth</span><span class="p">;</span>
  <span class="n">lfor</span> <span class="o">=</span> <span class="n">fdepth</span> <span class="o">+</span> <span class="n">lfor</span><span class="o">*</span><span class="n">fwidth</span><span class="p">;</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">lfol</span> <span class="o">&gt;</span> <span class="mf">1.0f</span><span class="p">)</span>
    <span class="n">lfol</span> <span class="o">=</span> <span class="mf">1.0f</span><span class="p">;</span>
  <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">lfol</span> <span class="o">&lt;</span> <span class="mf">0.0f</span><span class="p">)</span>
    <span class="n">lfol</span> <span class="o">=</span> <span class="mf">0.0f</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">lfor</span> <span class="o">&gt;</span> <span class="mf">1.0f</span><span class="p">)</span>
    <span class="n">lfor</span> <span class="o">=</span> <span class="mf">1.0f</span><span class="p">;</span>
  <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">lfor</span> <span class="o">&lt;</span> <span class="mf">0.0f</span><span class="p">)</span>
    <span class="n">lfor</span> <span class="o">=</span> <span class="mf">0.0f</span><span class="p">;</span>

    <span class="n">lfor</span> <span class="o">=</span> <span class="mf">2.0f</span> <span class="o">-</span> <span class="mf">2.0f</span><span class="o">/</span><span class="p">(</span><span class="n">lfor</span> <span class="o">+</span> <span class="mf">1.0f</span><span class="p">);</span>   <span class="c1">//</span>
    <span class="n">lfol</span> <span class="o">=</span> <span class="mf">2.0f</span> <span class="o">-</span> <span class="mf">2.0f</span><span class="o">/</span><span class="p">(</span><span class="n">lfol</span> <span class="o">+</span> <span class="mf">1.0f</span><span class="p">);</span> <span class="c1">//emulate lamp turn on/off characteristic by typical curves</span>

  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PERIOD</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
    <span class="c1">//Left Lamp</span>
     <span class="n">gl</span> <span class="o">=</span> <span class="n">lfol</span><span class="o">*</span><span class="n">lampTC</span> <span class="o">+</span> <span class="n">oldgl</span><span class="o">*</span><span class="n">ilampTC</span><span class="p">;</span>
     <span class="n">oldgl</span> <span class="o">=</span> <span class="n">gl</span><span class="p">;</span>
    <span class="c1">//Right Lamp</span>
     <span class="n">gr</span> <span class="o">=</span> <span class="n">lfor</span><span class="o">*</span><span class="n">lampTC</span> <span class="o">+</span> <span class="n">oldgr</span><span class="o">*</span><span class="n">ilampTC</span><span class="p">;</span>
     <span class="n">oldgr</span> <span class="o">=</span> <span class="n">gr</span><span class="p">;</span>

    <span class="c1">//Left Cds</span>
    <span class="n">stepl</span> <span class="o">=</span> <span class="n">gl</span><span class="o">*</span><span class="n">alphal</span> <span class="o">+</span> <span class="n">dalphal</span><span class="o">*</span><span class="n">oldstepl</span><span class="p">;</span>
    <span class="n">oldstepl</span> <span class="o">=</span> <span class="n">stepl</span><span class="p">;</span>
    <span class="n">dRCl</span> <span class="o">=</span> <span class="n">dTC</span><span class="o">*</span><span class="n">expf</span><span class="p">(</span><span class="n">stepl</span><span class="o">*</span><span class="n">minTC</span><span class="p">);</span>
    <span class="n">alphal</span> <span class="o">=</span> <span class="n">cSAMPLE_RATE</span><span class="o">/</span><span class="p">(</span><span class="n">dRCl</span> <span class="o">+</span> <span class="n">cSAMPLE_RATE</span><span class="p">);</span>
    <span class="n">dalphal</span> <span class="o">=</span> <span class="mf">1.0f</span> <span class="o">-</span> <span class="n">cSAMPLE_RATE</span><span class="o">/</span><span class="p">(</span><span class="mf">0.5f</span><span class="o">*</span><span class="n">dRCl</span> <span class="o">+</span> <span class="n">cSAMPLE_RATE</span><span class="p">);</span>     <span class="c1">//different attack &amp; release character</span>
    <span class="n">xl</span> <span class="o">=</span> <span class="n">CNST_E</span> <span class="o">+</span> <span class="n">stepl</span><span class="o">*</span><span class="n">b</span><span class="p">;</span>
    <span class="n">fxl</span> <span class="o">=</span> <span class="n">expf</span><span class="p">(</span><span class="n">Ra</span><span class="o">/</span><span class="n">logf</span><span class="p">(</span><span class="n">xl</span><span class="p">));</span>

    <span class="c1">//Right Cds</span>
    <span class="n">stepr</span> <span class="o">=</span> <span class="n">gr</span><span class="o">*</span><span class="n">alphar</span> <span class="o">+</span> <span class="n">dalphar</span><span class="o">*</span><span class="n">oldstepr</span><span class="p">;</span>
    <span class="n">oldstepr</span> <span class="o">=</span> <span class="n">stepr</span><span class="p">;</span>
    <span class="n">dRCr</span> <span class="o">=</span> <span class="n">dTC</span><span class="o">*</span><span class="n">expf</span><span class="p">(</span><span class="n">stepr</span><span class="o">*</span><span class="n">minTC</span><span class="p">);</span>
    <span class="n">alphar</span> <span class="o">=</span> <span class="n">cSAMPLE_RATE</span><span class="o">/</span><span class="p">(</span><span class="n">dRCr</span> <span class="o">+</span> <span class="n">cSAMPLE_RATE</span><span class="p">);</span>
    <span class="n">dalphar</span> <span class="o">=</span> <span class="mf">1.0f</span> <span class="o">-</span> <span class="n">cSAMPLE_RATE</span><span class="o">/</span><span class="p">(</span><span class="mf">0.5f</span><span class="o">*</span><span class="n">dRCr</span> <span class="o">+</span> <span class="n">cSAMPLE_RATE</span><span class="p">);</span>      <span class="c1">//different attack &amp; release character</span>
    <span class="n">xr</span> <span class="o">=</span> <span class="n">CNST_E</span> <span class="o">+</span> <span class="n">stepr</span><span class="o">*</span><span class="n">b</span><span class="p">;</span>
    <span class="n">fxr</span> <span class="o">=</span> <span class="n">expf</span><span class="p">(</span><span class="n">Ra</span><span class="o">/</span><span class="n">logf</span><span class="p">(</span><span class="n">xr</span><span class="p">));</span>

    <span class="k">if</span><span class="p">(</span><span class="n">i</span><span class="o">%</span><span class="mi">16</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>  <span class="n">modulate</span><span class="p">(</span><span class="n">fxl</span><span class="p">,</span> <span class="n">fxr</span><span class="p">);</span>

    <span class="c1">//Left Channel</span>

   <span class="n">input</span> <span class="o">=</span> <span class="n">bjt_shape</span><span class="p">(</span><span class="n">fbl</span> <span class="o">+</span> <span class="n">smpsl</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>


    <span class="n">emitterfb</span> <span class="o">=</span> <span class="mf">25.0f</span><span class="o">/</span><span class="n">fxl</span><span class="p">;</span>
    <span class="k">for</span><span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">j</span><span class="o">&lt;</span><span class="mi">4</span><span class="p">;</span><span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="c1">//4 stages phasing</span>
    <span class="p">{</span>
   <span class="n">cvolt</span> <span class="o">=</span> <span class="n">vibefilter</span><span class="p">(</span><span class="n">input</span><span class="p">,</span><span class="n">ecvc</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="o">+</span> <span class="n">vibefilter</span><span class="p">(</span><span class="n">input</span> <span class="o">+</span> <span class="n">emitterfb</span><span class="o">*</span><span class="n">oldcvolt</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="n">vc</span><span class="p">,</span><span class="n">j</span><span class="p">);</span>
   <span class="n">ocvolt</span> <span class="o">=</span> <span class="n">vibefilter</span><span class="p">(</span><span class="n">cvolt</span><span class="p">,</span><span class="n">vcvo</span><span class="p">,</span><span class="n">j</span><span class="p">);</span>
   <span class="n">oldcvolt</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">ocvolt</span><span class="p">;</span>
   <span class="n">evolt</span> <span class="o">=</span> <span class="n">vibefilter</span><span class="p">(</span><span class="n">input</span><span class="p">,</span> <span class="n">vevo</span><span class="p">,</span><span class="n">j</span><span class="p">);</span>

   <span class="n">input</span> <span class="o">=</span> <span class="n">bjt_shape</span><span class="p">(</span><span class="n">ocvolt</span> <span class="o">+</span> <span class="n">evolt</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">fbl</span> <span class="o">=</span> <span class="n">fb</span><span class="o">*</span><span class="n">ocvolt</span><span class="p">;</span>
    <span class="n">outl</span> <span class="o">=</span> <span class="n">lpanning</span><span class="o">*</span><span class="n">input</span><span class="p">;</span>

    <span class="c1">//Right channel</span>

    <span class="n">input</span> <span class="o">=</span> <span class="n">bjt_shape</span><span class="p">(</span><span class="n">fbr</span> <span class="o">+</span> <span class="n">smpsr</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

    <span class="n">emitterfb</span> <span class="o">=</span> <span class="mf">25.0f</span><span class="o">/</span><span class="n">fxr</span><span class="p">;</span>
    <span class="k">for</span><span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="mi">4</span><span class="p">;</span><span class="n">j</span><span class="o">&lt;</span><span class="mi">8</span><span class="p">;</span><span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="c1">//4 stages phasing</span>
    <span class="p">{</span>
   <span class="n">cvolt</span> <span class="o">=</span> <span class="n">vibefilter</span><span class="p">(</span><span class="n">input</span><span class="p">,</span><span class="n">ecvc</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="o">+</span> <span class="n">vibefilter</span><span class="p">(</span><span class="n">input</span> <span class="o">+</span> <span class="n">emitterfb</span><span class="o">*</span><span class="n">oldcvolt</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="n">vc</span><span class="p">,</span><span class="n">j</span><span class="p">);</span>
   <span class="n">ocvolt</span> <span class="o">=</span> <span class="n">vibefilter</span><span class="p">(</span><span class="n">cvolt</span><span class="p">,</span><span class="n">vcvo</span><span class="p">,</span><span class="n">j</span><span class="p">);</span>
   <span class="n">oldcvolt</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">ocvolt</span><span class="p">;</span>
   <span class="n">evolt</span> <span class="o">=</span> <span class="n">vibefilter</span><span class="p">(</span><span class="n">input</span><span class="p">,</span> <span class="n">vevo</span><span class="p">,</span><span class="n">j</span><span class="p">);</span>

   <span class="n">input</span> <span class="o">=</span> <span class="n">bjt_shape</span><span class="p">(</span><span class="n">ocvolt</span> <span class="o">+</span> <span class="n">evolt</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">fbr</span> <span class="o">=</span> <span class="n">fb</span><span class="o">*</span><span class="n">ocvolt</span><span class="p">;</span>
    <span class="n">outr</span> <span class="o">=</span> <span class="n">rpanning</span><span class="o">*</span><span class="n">input</span><span class="p">;</span>

    <span class="n">efxoutl</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">outl</span><span class="o">*</span><span class="n">fcross</span> <span class="o">+</span> <span class="n">outr</span><span class="o">*</span><span class="n">flrcross</span><span class="p">;</span>
    <span class="n">efxoutr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">outr</span><span class="o">*</span><span class="n">fcross</span> <span class="o">+</span> <span class="n">outl</span><span class="o">*</span><span class="n">flrcross</span><span class="p">;</span>

    <span class="p">};</span>

<span class="p">};</span>

<span class="kt">float</span>
<span class="n">Vibe</span><span class="o">::</span><span class="n">vibefilter</span><span class="p">(</span><span class="kt">float</span> <span class="n">data</span><span class="p">,</span> <span class="n">fparams</span> <span class="o">*</span><span class="n">ftype</span><span class="p">,</span> <span class="kt">int</span> <span class="n">stage</span><span class="p">)</span>
<span class="p">{</span>
<span class="kt">float</span> <span class="n">y0</span> <span class="o">=</span> <span class="mf">0.0f</span><span class="p">;</span>
<span class="n">y0</span> <span class="o">=</span> <span class="n">data</span><span class="o">*</span><span class="n">ftype</span><span class="p">[</span><span class="n">stage</span><span class="p">].</span><span class="n">n0</span> <span class="o">+</span> <span class="n">ftype</span><span class="p">[</span><span class="n">stage</span><span class="p">].</span><span class="n">x1</span><span class="o">*</span><span class="n">ftype</span><span class="p">[</span><span class="n">stage</span><span class="p">].</span><span class="n">n1</span> <span class="o">-</span> <span class="n">ftype</span><span class="p">[</span><span class="n">stage</span><span class="p">].</span><span class="n">y1</span><span class="o">*</span><span class="n">ftype</span><span class="p">[</span><span class="n">stage</span><span class="p">].</span><span class="n">d1</span><span class="p">;</span>
<span class="n">ftype</span><span class="p">[</span><span class="n">stage</span><span class="p">].</span><span class="n">y1</span> <span class="o">=</span> <span class="n">y0</span> <span class="o">+</span> <span class="n">DENORMAL_GUARD</span><span class="p">;</span>
<span class="n">ftype</span><span class="p">[</span><span class="n">stage</span><span class="p">].</span><span class="n">x1</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
<span class="k">return</span> <span class="n">y0</span><span class="p">;</span>
<span class="p">};</span>

<span class="kt">float</span>
<span class="n">Vibe</span><span class="o">::</span><span class="n">bjt_shape</span><span class="p">(</span><span class="kt">float</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
<span class="kt">float</span> <span class="n">vbe</span><span class="p">,</span> <span class="n">vout</span><span class="p">;</span>
<span class="kt">float</span> <span class="n">vin</span> <span class="o">=</span> <span class="mf">7.5f</span><span class="o">*</span><span class="p">(</span><span class="mf">1.0f</span> <span class="o">+</span> <span class="n">data</span><span class="p">);</span>
<span class="k">if</span><span class="p">(</span><span class="n">vin</span><span class="o">&lt;</span><span class="mf">0.0f</span><span class="p">)</span> <span class="n">vin</span> <span class="o">=</span> <span class="mf">0.0f</span><span class="p">;</span>
<span class="k">if</span><span class="p">(</span><span class="n">vin</span><span class="o">&gt;</span><span class="mf">15.0f</span><span class="p">)</span> <span class="n">vin</span> <span class="o">=</span> <span class="mf">15.0f</span><span class="p">;</span>
<span class="n">vbe</span> <span class="o">=</span> <span class="mf">0.8f</span> <span class="o">-</span> <span class="mf">0.8f</span><span class="o">/</span><span class="p">(</span><span class="n">vin</span> <span class="o">+</span> <span class="mf">1.0f</span><span class="p">);</span>  <span class="c1">//really rough, simplistic bjt turn-on emulator</span>
<span class="n">vout</span> <span class="o">=</span> <span class="n">vin</span> <span class="o">-</span> <span class="n">vbe</span><span class="p">;</span>
<span class="n">vout</span> <span class="o">=</span> <span class="n">vout</span><span class="o">*</span><span class="mf">0.1333333333f</span> <span class="o">-</span><span class="mf">0.90588f</span><span class="p">;</span>  <span class="c1">//some magic numbers to return gain to unity &amp; zero the DC</span>
<span class="k">return</span> <span class="n">vout</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="n">Vibe</span><span class="o">::</span><span class="n">init_vibes</span><span class="p">()</span>
<span class="p">{</span>
<span class="n">k</span> <span class="o">=</span> <span class="mf">2.0f</span><span class="o">*</span><span class="n">fSAMPLE_RATE</span><span class="p">;</span>
<span class="kt">float</span> <span class="n">tmpgain</span> <span class="o">=</span> <span class="mf">1.0f</span><span class="p">;</span>
 <span class="n">R1</span> <span class="o">=</span> <span class="mf">4700.0f</span><span class="p">;</span>
 <span class="n">Rv</span> <span class="o">=</span> <span class="mf">4700.0f</span><span class="p">;</span>
 <span class="n">C2</span> <span class="o">=</span> <span class="mf">1e-6</span><span class="n">f</span><span class="p">;</span>
 <span class="n">beta</span> <span class="o">=</span> <span class="mf">150.0f</span><span class="p">;</span>  <span class="c1">//transistor forward gain.</span>
 <span class="n">gain</span> <span class="o">=</span> <span class="o">-</span><span class="n">beta</span><span class="o">/</span><span class="p">(</span><span class="n">beta</span> <span class="o">+</span> <span class="mf">1.0f</span><span class="p">);</span>

<span class="c1">//Univibe cap values 0.015uF, 0.22uF, 470pF, and 0.0047uF</span>
<span class="n">C1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.015e-6</span><span class="n">f</span><span class="p">;</span>
<span class="n">C1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.22e-6</span><span class="n">f</span><span class="p">;</span>
<span class="n">C1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mf">470e-12</span><span class="n">f</span><span class="p">;</span>
<span class="n">C1</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0047e-6</span><span class="n">f</span><span class="p">;</span>
<span class="n">C1</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.015e-6</span><span class="n">f</span><span class="p">;</span>
<span class="n">C1</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.22e-6</span><span class="n">f</span><span class="p">;</span>
<span class="n">C1</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mf">470e-12</span><span class="n">f</span><span class="p">;</span>
<span class="n">C1</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0047e-6</span><span class="n">f</span><span class="p">;</span>

<span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="p">{</span>
<span class="c1">//Vo/Ve driven from emitter</span>
<span class="n">en1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">k</span><span class="o">*</span><span class="n">R1</span><span class="o">*</span><span class="n">C1</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="n">en0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0f</span><span class="p">;</span>
<span class="n">ed1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">k</span><span class="o">*</span><span class="p">(</span><span class="n">R1</span> <span class="o">+</span> <span class="n">Rv</span><span class="p">)</span><span class="o">*</span><span class="n">C1</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="n">ed0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0f</span> <span class="o">+</span> <span class="n">C1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">C2</span><span class="p">;</span>

<span class="c1">// Vc~=Ve/(Ic*Re*alpha^2) collector voltage from current input.</span>
<span class="c1">//Output here represents voltage at the collector</span>

<span class="n">cn1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">k</span><span class="o">*</span><span class="n">gain</span><span class="o">*</span><span class="n">Rv</span><span class="o">*</span><span class="n">C1</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="n">cn0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">gain</span><span class="o">*</span><span class="p">(</span><span class="mf">1.0f</span> <span class="o">+</span> <span class="n">C1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">C2</span><span class="p">);</span>
<span class="n">cd1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">k</span><span class="o">*</span><span class="p">(</span><span class="n">R1</span> <span class="o">+</span> <span class="n">Rv</span><span class="p">)</span><span class="o">*</span><span class="n">C1</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="n">cd0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0f</span> <span class="o">+</span> <span class="n">C1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">C2</span><span class="p">;</span>

<span class="c1">//Contribution from emitter load through passive filter network</span>
<span class="n">ecn1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">k</span><span class="o">*</span><span class="n">gain</span><span class="o">*</span><span class="n">R1</span><span class="o">*</span><span class="p">(</span><span class="n">R1</span> <span class="o">+</span> <span class="n">Rv</span><span class="p">)</span><span class="o">*</span><span class="n">C1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">C2</span><span class="o">/</span><span class="p">(</span><span class="n">Rv</span><span class="o">*</span><span class="p">(</span><span class="n">C2</span> <span class="o">+</span> <span class="n">C1</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
<span class="n">ecn0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0f</span><span class="p">;</span>
<span class="n">ecd1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">k</span><span class="o">*</span><span class="p">(</span><span class="n">R1</span> <span class="o">+</span> <span class="n">Rv</span><span class="p">)</span><span class="o">*</span><span class="n">C1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">C2</span><span class="o">/</span><span class="p">(</span><span class="n">C2</span> <span class="o">+</span> <span class="n">C1</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="n">ecd0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0f</span><span class="p">;</span>

<span class="c1">// %Represents Vo/Vc.  Output over collector voltage</span>
<span class="n">on1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">k</span><span class="o">*</span><span class="n">Rv</span><span class="o">*</span><span class="n">C2</span><span class="p">;</span>
<span class="n">on0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0f</span><span class="p">;</span>
<span class="n">od1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">k</span><span class="o">*</span><span class="n">Rv</span><span class="o">*</span><span class="n">C2</span><span class="p">;</span>
<span class="n">od0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0f</span> <span class="o">+</span> <span class="n">C2</span><span class="o">/</span><span class="n">C1</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

<span class="c1">//%Bilinear xform stuff</span>
<span class="n">tmpgain</span> <span class="o">=</span>  <span class="mf">1.0f</span><span class="o">/</span><span class="p">(</span><span class="n">cd1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">cd0</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="n">vc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">n1</span> <span class="o">=</span> <span class="n">tmpgain</span><span class="o">*</span><span class="p">(</span><span class="n">cn0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">cn1</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="n">vc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">n0</span> <span class="o">=</span> <span class="n">tmpgain</span><span class="o">*</span><span class="p">(</span><span class="n">cn1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">cn0</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="n">vc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">d1</span> <span class="o">=</span> <span class="n">tmpgain</span><span class="o">*</span><span class="p">(</span><span class="n">cd0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">cd1</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="n">vc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">d0</span> <span class="o">=</span> <span class="mf">1.0f</span><span class="p">;</span>

<span class="n">tmpgain</span> <span class="o">=</span>  <span class="mf">1.0f</span><span class="o">/</span><span class="p">(</span><span class="n">ecd1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">ecd0</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="n">ecvc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">n1</span> <span class="o">=</span> <span class="n">tmpgain</span><span class="o">*</span><span class="p">(</span><span class="n">ecn0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">ecn1</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="n">ecvc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">n0</span> <span class="o">=</span> <span class="n">tmpgain</span><span class="o">*</span><span class="p">(</span><span class="n">ecn1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">ecn0</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="n">ecvc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">d1</span> <span class="o">=</span> <span class="n">tmpgain</span><span class="o">*</span><span class="p">(</span><span class="n">ecd0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">ecd1</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="n">ecvc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">d0</span> <span class="o">=</span> <span class="mf">1.0f</span><span class="p">;</span>

<span class="n">tmpgain</span> <span class="o">=</span>  <span class="mf">1.0f</span><span class="o">/</span><span class="p">(</span><span class="n">od1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">od0</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="n">vcvo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">n1</span> <span class="o">=</span> <span class="n">tmpgain</span><span class="o">*</span><span class="p">(</span><span class="n">on0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">on1</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="n">vcvo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">n0</span> <span class="o">=</span> <span class="n">tmpgain</span><span class="o">*</span><span class="p">(</span><span class="n">on1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">on0</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="n">vcvo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">d1</span> <span class="o">=</span> <span class="n">tmpgain</span><span class="o">*</span><span class="p">(</span><span class="n">od0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">od1</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="n">vcvo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">d0</span> <span class="o">=</span> <span class="mf">1.0f</span><span class="p">;</span>

<span class="n">tmpgain</span> <span class="o">=</span>  <span class="mf">1.0f</span><span class="o">/</span><span class="p">(</span><span class="n">ed1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">ed0</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="n">vevo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">n1</span> <span class="o">=</span> <span class="n">tmpgain</span><span class="o">*</span><span class="p">(</span><span class="n">en0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">en1</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="n">vevo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">n0</span> <span class="o">=</span> <span class="n">tmpgain</span><span class="o">*</span><span class="p">(</span><span class="n">en1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">en0</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="n">vevo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">d1</span> <span class="o">=</span> <span class="n">tmpgain</span><span class="o">*</span><span class="p">(</span><span class="n">ed0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">ed1</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="n">vevo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">d0</span> <span class="o">=</span> <span class="mf">1.0f</span><span class="p">;</span>

<span class="c1">// bootstrap[i].n1</span>
<span class="c1">// bootstrap[i].n0</span>
<span class="c1">// bootstrap[i].d1</span>
<span class="p">}</span>


<span class="p">};</span>

<span class="kt">void</span>
<span class="n">Vibe</span><span class="o">::</span><span class="n">modulate</span><span class="p">(</span><span class="kt">float</span> <span class="n">ldrl</span><span class="p">,</span> <span class="kt">float</span> <span class="n">ldrr</span><span class="p">)</span>
<span class="p">{</span>
<span class="kt">float</span> <span class="n">tmpgain</span><span class="p">;</span>
<span class="kt">float</span> <span class="n">R1pRv</span><span class="p">;</span>
<span class="kt">float</span> <span class="n">C2pC1</span><span class="p">;</span>
<span class="n">Rv</span> <span class="o">=</span> <span class="mf">4700.0f</span> <span class="o">+</span> <span class="n">ldrl</span><span class="p">;</span>
<span class="n">R1pRv</span> <span class="o">=</span> <span class="n">R1</span> <span class="o">+</span> <span class="n">Rv</span><span class="p">;</span>


<span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="p">{</span>
<span class="k">if</span><span class="p">(</span><span class="n">i</span><span class="o">==</span><span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
<span class="n">Rv</span> <span class="o">=</span> <span class="mf">4700.0f</span> <span class="o">+</span> <span class="n">ldrr</span><span class="p">;</span>
<span class="n">R1pRv</span> <span class="o">=</span> <span class="n">R1</span> <span class="o">+</span> <span class="n">Rv</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">C2pC1</span> <span class="o">=</span> <span class="n">C2</span> <span class="o">+</span> <span class="n">C1</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="c1">//Vo/Ve driven from emitter</span>
<span class="n">ed1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">k</span><span class="o">*</span><span class="p">(</span><span class="n">R1pRv</span><span class="p">)</span><span class="o">*</span><span class="n">C1</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="c1">//ed1[i] = R1pRv*kC1[i];</span>

<span class="c1">// Vc~=Ve/(Ic*Re*alpha^2) collector voltage from current input.</span>
<span class="c1">//Output here represents voltage at the collector</span>
<span class="n">cn1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">k</span><span class="o">*</span><span class="n">gain</span><span class="o">*</span><span class="n">Rv</span><span class="o">*</span><span class="n">C1</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="c1">//cn1[i] = kgainCl[i]*Rv;</span>
<span class="c1">//cd1[i] = (R1pRv)*C1[i];</span>
<span class="n">cd1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">ed1</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

<span class="c1">//Contribution from emitter load through passive filter network</span>
<span class="n">ecn1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">k</span><span class="o">*</span><span class="n">gain</span><span class="o">*</span><span class="n">R1</span><span class="o">*</span><span class="n">cd1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">C2</span><span class="o">/</span><span class="p">(</span><span class="n">Rv</span><span class="o">*</span><span class="p">(</span><span class="n">C2pC1</span><span class="p">));</span>
<span class="c1">//ecn1[i] = iC2pC1[i]*kgainR1C2*cd1[i]/Rv;</span>
<span class="n">ecd1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">k</span><span class="o">*</span><span class="n">cd1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">C2</span><span class="o">/</span><span class="p">(</span><span class="n">C2pC1</span><span class="p">);</span>
<span class="c1">//ecd1[i] = iC2pC1[i]*k*cd1[i]*C2/(C2pC1);</span>

<span class="c1">// %Represents Vo/Vc.  Output over collector voltage</span>
<span class="n">on1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">k</span><span class="o">*</span><span class="n">Rv</span><span class="o">*</span><span class="n">C2</span><span class="p">;</span>
<span class="n">od1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">on1</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

<span class="c1">//%Bilinear xform stuff</span>
<span class="n">tmpgain</span> <span class="o">=</span>  <span class="mf">1.0f</span><span class="o">/</span><span class="p">(</span><span class="n">cd1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">cd0</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="n">vc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">n1</span> <span class="o">=</span> <span class="n">tmpgain</span><span class="o">*</span><span class="p">(</span><span class="n">cn0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">cn1</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="n">vc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">n0</span> <span class="o">=</span> <span class="n">tmpgain</span><span class="o">*</span><span class="p">(</span><span class="n">cn1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">cn0</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="n">vc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">d1</span> <span class="o">=</span> <span class="n">tmpgain</span><span class="o">*</span><span class="p">(</span><span class="n">cd0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">cd1</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

<span class="n">tmpgain</span> <span class="o">=</span>  <span class="mf">1.0f</span><span class="o">/</span><span class="p">(</span><span class="n">ecd1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">ecd0</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="n">ecvc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">n1</span> <span class="o">=</span> <span class="n">tmpgain</span><span class="o">*</span><span class="p">(</span><span class="n">ecn0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">ecn1</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="n">ecvc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">n0</span> <span class="o">=</span> <span class="n">tmpgain</span><span class="o">*</span><span class="p">(</span><span class="n">ecn1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">ecn0</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="n">ecvc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">d1</span> <span class="o">=</span> <span class="n">tmpgain</span><span class="o">*</span><span class="p">(</span><span class="n">ecd0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">ecd1</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="n">ecvc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">d0</span> <span class="o">=</span> <span class="mf">1.0f</span><span class="p">;</span>

<span class="n">tmpgain</span> <span class="o">=</span>  <span class="mf">1.0f</span><span class="o">/</span><span class="p">(</span><span class="n">od1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">od0</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="n">vcvo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">n1</span> <span class="o">=</span> <span class="n">tmpgain</span><span class="o">*</span><span class="p">(</span><span class="n">on0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">on1</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="n">vcvo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">n0</span> <span class="o">=</span> <span class="n">tmpgain</span><span class="o">*</span><span class="p">(</span><span class="n">on1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">on0</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="n">vcvo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">d1</span> <span class="o">=</span> <span class="n">tmpgain</span><span class="o">*</span><span class="p">(</span><span class="n">od0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">od1</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

<span class="n">tmpgain</span> <span class="o">=</span>  <span class="mf">1.0f</span><span class="o">/</span><span class="p">(</span><span class="n">ed1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">ed0</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="n">vevo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">n1</span> <span class="o">=</span> <span class="n">tmpgain</span><span class="o">*</span><span class="p">(</span><span class="n">en0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">en1</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="n">vevo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">n0</span> <span class="o">=</span> <span class="n">tmpgain</span><span class="o">*</span><span class="p">(</span><span class="n">en1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">en0</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="n">vevo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">d1</span> <span class="o">=</span> <span class="n">tmpgain</span><span class="o">*</span><span class="p">(</span><span class="n">ed0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">ed1</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

<span class="p">}</span>


<span class="p">};</span>
</pre></div>
</td></tr></table></div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="104-variable-hardness-clipping-function.html" class="btn btn-neutral float-right" title="Variable-hardness clipping function" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="177-transistor-differential-amplifier-simulation.html" class="btn btn-neutral float-left" title="Transistor differential amplifier simulation" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Too many to list

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>